!function(){"use strict";function t(t,e){if(!t)return!1;for(const s of t)if(!e||e(s))return!0;return!1}function e(t,e){const s=t.stateGet();s.has(e)||t.update({state:s.add(e)})}function s(t,e){const s=t.stateGet();var n,i;s.has(e)&&t.update({state:(n=s,i=e,n.delete(i),n)})}function n(t){const e=t.shape.postionGet(),s=t.innerPosition;return{templateKey:"connect-end",position:{x:e.x+s.x,y:e.y+s.y},postionIsIntoCanvas:!0,rotate:"out"===t.connectorType?"right"===t.dir?0:"left"===t.dir?180:"bottom"===t.dir?90:270:"right"===t.dir?180:"left"===t.dir?0:"bottom"===t.dir?270:90}}class i{constructor(t){this.t=t}add(t,e){const s=this.t.append("path",{templateKey:"path",start:{position:i.i(t),dir:t.dir},end:{position:i.i(e),dir:e.dir?e.dir:i.o(t.dir)}});s.start=t,s.end=e,i.h(t.shape,s),i.h(e.shape,s)}replaceEnd(t,e){const s=function(t,e){if(!t)return null;let s;for(const n of t)e&&!e(n)||(s=n);return s}(t.shape.connectedPaths,(e=>e.end===t));s.update({end:{position:i.i(e),dir:e.dir?e.dir:t.dir}}),s.end=e,t.shape!==e.shape&&(s.start.shape!==t.shape&&t.shape.connectedPaths.delete(s),i.h(e.shape,s))}updatePosition(e){if(!t(e.connectedPaths))return;const s=e.postionGet();for(const t of e.connectedPaths)t.update({start:t.start.shape===e?{position:{x:s.x+t.start.innerPosition.x,y:s.y+t.start.innerPosition.y}}:null,end:t.end.shape===e?{position:{x:s.x+t.end.innerPosition.x,y:s.y+t.end.innerPosition.y}}:null})}deleteByShape(e){if(t(e.connectedPaths))for(const t of e.connectedPaths)t.end.shape.connectedPaths.delete(t),s(t.end,"connected"),t.start.shape.connectedPaths.delete(t),s(t.start,"connected"),t.end.shape.connectable&&this.t.delete(t.end.shape),this.t.delete(t)}any(e){return t(e.shape.connectedPaths,(t=>t.start===e||t.end===e))}static h(t,e){t.connectedPaths||(t.connectedPaths=new Set),t.connectedPaths.add(e)}static i(t){const e=t.shape.postionGet();return{x:e.x+t.innerPosition.x,y:e.y+t.innerPosition.y}}static o(t){switch(t){case"bottom":return"top";case"top":return"bottom";case"left":return"right";case"right":return"left"}}}class o extends EventTarget{constructor(t,e){super(),this.t=t.on("pointermove",this).on("pointerdown",this).on("pointerup",this).on("pointerenter",this).on("pointerleave",this),this.l=e}on(t,e){return this.addEventListener(t,e),this}shapeAdd(t,e){return this.t.append(t,e)}shapeUpdate(t){const e=t.shape?t.shape:this.t.querySelector(t.selector);return e.update(t),e}shapeDel(t){const e=t.shape?t.shape:this.t.querySelector(t.selector);this.l.deleteByShape(e),this.t.delete(e)}handleEvent(t){switch(t.type){case"pointermove":if(this.u){const e={x:this.p.x+t.detail.offsetX,y:this.p.y+t.detail.offsetY};this.u.update({position:e}),this.l.updatePosition(this.u)}break;case"pointerdown":switch(t.detail.target.type){case"canvas":case"shape":this.v(t.detail.target,{x:t.detail.offsetX,y:t.detail.offsetY});break;case"connector":this.m(t)}break;case"pointerup":"connector"===t.detail.target.type&&this.g(t),this._(),this.C();break;case"pointerenter":this.u&&this.u.connectable&&("connector"===t.detail.target.type||"shape"===t.detail.target.type)&&this.k(t.detail.target);break;case"pointerleave":this.C()}}m(t){switch(t.detail.target.connectorType){case"out":{const e=this.shapeAdd("shape",n(t.detail.target));this.v(e,{x:t.detail.offsetX,y:t.detail.offsetY}),this.l.add(t.detail.target,e.defaultInConnector);break}case"in":if(t.detail.target.stateGet().has("connected")){const e=this.shapeAdd("shape",n(t.detail.target));this.v(e,{x:t.detail.offsetX,y:t.detail.offsetY}),this.l.replaceEnd(t.detail.target,e.defaultInConnector),this.l.any(t.detail.target)||s(t.detail.target,"connected")}}}g(t){this.u&&this.u.connectable&&"in"===t.detail.target.connectorType&&(this.l.replaceEnd(this.u.defaultInConnector,t.detail.target),this.shapeDel({shape:this.u}),e(t.detail.target,"connected"))}S(t){t!==this.T&&(this.$("select",t),this.T&&s(this.T,"selected"),t&&e(t,"selected"),this.T=t)}v(t,s){this.u=t,this.u.connectable&&e(this.u,"disabled");const n=this.u.postionGet();this.p={x:n.x-s.x,y:n.y-s.y},this.S(this.u)}_(){this.u&&s(this.u,"disabled"),this.p=null,this.u=null}k(t){this.P=t,e(t,"hovered"),"connector"===t.type&&e(t.shape,"hovered")}C(){this.P&&(s(this.P,"hovered"),"connector"===this.P.type&&s(this.P.shape,"hovered"),this.P=null)}$(t,e){return this.dispatchEvent(new CustomEvent(t,{cancelable:!0,detail:{target:e}}))}}class r{constructor({svgEl:t,start:e,end:s}){this.svgEl=t,this.j=e,this.G=s,this.type="path",this.O()}update(t){t.start&&Object.assign(this.j,t.start),t.end&&Object.assign(this.G,t.end),this.O()}O(){this.svgEl.setAttribute("d",r.A(70,this.j,this.G))}static A(t,e,s){return`M ${e.position.x} ${e.position.y} C ${r.D(e.dir,e.position.x,t)} ${r.I(e.dir,e.position.y,t)}, ${r.D(s.dir,s.position.x,t)} ${r.I(s.dir,s.position.y,t)}, ${s.position.x} ${s.position.y}`}static D(t,e,s){return"right"===t||"left"===t?"right"===t?e+s:e-s:e}static I(t,e,s){return"right"===t||"left"===t?e:"bottom"===t?e+s:e-s}}function h(t,e,s){let n=function(t,e){for(const s of t)if(!e||e(s))return s;return null}(t.transform.baseVal,(t=>t.type===e));return n||(n=(t.ownerSVGElement||s).createSVGTransform(),t.transform.baseVal.appendItem(n)),n}function c(t){const e=h(t,SVGTransform.SVG_TRANSFORM_TRANSLATE).matrix;return{x:e.e,y:e.f}}class a{constructor({svgEl:t,connectorType:e,shape:s,innerPosition:n,dir:i}){this.K=t,this.M=new Set,this.type="connector",this.connectorType=e,this.shape=s,this.innerPosition=n,this.dir=i}stateGet(){return this.M}update(t){this.M=t.state,this.M.has("connected")?this.K.classList.add("connected"):this.K.classList.remove("connected"),this.M.has("hovered")?this.K.classList.add("hover"):this.K.classList.remove("hover")}}class l{constructor({svgEl:t,type:e=null,connectable:s=null,defaultInConnector:n=null}){this.M=new Set,this.svgEl=t,this.type=e||"shape",this.connectable=s,this.defaultInConnector=n}stateGet(){return this.M}postionGet(){return c(this.svgEl)}update(t){var e,s,n;t.position&&(e=this.svgEl,s=t.position,h(e,SVGTransform.SVG_TRANSFORM_TRANSLATE,n).setTranslate(s.x,s.y)),t.rotate&&function(t,e,s){h(t,SVGTransform.SVG_TRANSFORM_ROTATE,s).setRotate(e,0,0)}(this.svgEl,t.rotate),t.props&&l.V(this.svgEl,t.props),t.state&&(this.M=t.state,this.M.has("selected")?this.svgEl.classList.add("selected"):this.svgEl.classList.remove("selected"),this.M.has("hovered")?this.svgEl.classList.add("hover"):this.svgEl.classList.remove("hover"),this.M.has("disabled")?this.svgEl.style.pointerEvents="none":this.svgEl.style.pointerEvents="auto")}static V(t,e){Object.keys(e).forEach((s=>{const n="root"===s?t:t.querySelector(`[data-name='${s}'`);Object.keys(e[s]).forEach((t=>{if("textContent"===t)n.textContent=e[s][t].toString();else n.setAttribute(t,e[s][t].toString())}))}))}}function u(t,e){return new a({svgEl:t,connectorType:"in"===t.getAttribute("data-connect")?"in":"out",shape:e,innerPosition:d(t),dir:t.getAttribute("data-connect-dir")})}function d(t){if(!t.getAttribute("data-connect-point"))return null;const e=t.getAttribute("data-connect-point").split(",");return{x:parseFloat(e[0]),y:parseFloat(e[1])}}class p extends EventTarget{constructor(t){super(),this.F=t,this.F.addEventListener("pointermove",this),this.F.addEventListener("pointerdown",this),this.F.addEventListener("pointerup",this),this.U=new WeakMap,this.W=t.querySelector('[data-name="canvas"]'),this.U.set(this.W,new l({svgEl:this.W,type:"canvas"}))}append(t,e){switch(t){case"shape":return function({svgCanvas:t,listener:e,svgElemToPresenterObj:s,createParams:n}){const i=t.ownerSVGElement.getElementsByTagName("defs")[0].querySelector(`[data-templ='${n.templateKey}']`).cloneNode(!0);t.append(i);const o=new l({svgEl:i});if(!n.postionIsIntoCanvas){const e=c(t);n.position.x-=e.x,n.position.y-=e.y}return o.update(n),o.connectable="true"===i.getAttribute("data-connectable"),d(i)&&(o.defaultInConnector=u(i,o)),i.addEventListener("pointerdown",e),i.querySelectorAll("[data-connect]").forEach((t=>{const n=u(t,o);t.addEventListener("pointerdown",e),s.set(t,n)})),s.set(i,o),o}({svgCanvas:this.W,svgElemToPresenterObj:this.U,listener:this,createParams:e});case"path":return function({svgCanvas:t,createParams:e}){const s=t.ownerSVGElement.getElementsByTagName("defs")[0].querySelector(`[data-templ='${e.templateKey}']`).cloneNode(!0);return t.append(s),new r({svgEl:s,start:e.start,end:e.end})}({svgCanvas:this.W,createParams:e})}}delete(t){this.U.delete(t.svgEl),t.svgEl.remove()}querySelector(t){const e=this.F.querySelector(t);return e?this.U.get(e):null}on(t,e){return this.addEventListener(t,e),this}handleEvent(t){switch(t.stopPropagation(),t.type){case"pointermove":this.q(t),this.$("pointermove",null,t.offsetX,t.offsetY);break;case"pointerdown":this.$(t.type,t.currentTarget,t.offsetX,t.offsetY);break;case"pointerup":this.$(t.type,document.elementFromPoint(t.clientX,t.clientY),t.offsetX,t.offsetY)}}q(t){const e=document.elementFromPoint(t.clientX,t.clientY);e!==this.B&&(this.B&&this.$("pointerleave",this.B,t.offsetX,t.offsetY),e&&this.$("pointerenter",e,t.offsetX,t.offsetY),this.B=e)}$(t,e,s,n){let i=null;e&&(i=this.U.get(e===this.F||e.ownerSVGElement!==this.F?this.W:e),i||(i=this.U.get(e.closest("[data-connect]"))),i||(i=this.U.get(e.closest("[data-templ]")))),this.dispatchEvent(new CustomEvent(t,{detail:{target:i,offsetX:s,offsetY:n}}))}}const f=document.getElementById("panel"),v=document.getElementById("text");v.addEventListener("input",(t=>b())),v.addEventListener("change",(t=>b())),document.getElementById("del").addEventListener("click",(t=>{t.preventDefault(),function(){if(!g)return;m.delete(g),w.shapeDel({shape:g}),y(null)}()})),document.getElementById("gear").addEventListener("click",(t=>{t.preventDefault(),f.classList.contains("open")?f.classList.remove("open"):f.classList.add("open")})),document.getElementById("menu").querySelectorAll("[data-shape]").forEach((t=>t.addEventListener("click",(t=>{var e;t.preventDefault(),e=t.currentTarget.getAttribute("data-shape"),m.set(w.shapeAdd("shape",{templateKey:e,position:{x:120,y:120},props:{text:{textContent:"Title"}}}),"Title")}))));const m=new WeakMap;let g;const w=function(t){const e=new p(t);return new o(e,new i(e))}(document.getElementById("diagram")).on("select",(t=>y(t.detail.target)));function b(){g&&(m.set(g,v.value),g.update({props:{text:{textContent:v.value}}}))}function y(t){t&&"shape"===t.type?(g=t,f.classList.add("selected"),m.has(t)?(v.value=m.get(t),v.disabled=!1):(v.value=null,v.disabled=!0)):(g=null,f.classList.remove("selected"))}}();
