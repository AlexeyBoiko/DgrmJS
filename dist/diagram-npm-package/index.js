function t(t,e){if(!t)return null;let s;for(const n of t)e&&!e(n)||(s=n);return s}function e(t,e){if(!t)return!1;for(const s of t)if(!e||e(s))return!0;return!1}function s(t,e){if(!t.stateHas(e)){const s=t.stateGet();t.update({state:s.add(e)})}}function n(t,e){if(t.stateHas(e)){const i=t.stateGet();t.update({state:(s=i,n=e,s.delete(n),s)})}var s,n}function i(t){const e=t.shape.postionGet(),s=t.innerPosition;return{templateKey:"connect-end",position:{x:e.x+s.x,y:e.y+s.y},postionIsIntoCanvas:!0,rotate:"out"===t.connectorType?"right"===t.dir?0:"left"===t.dir?180:"bottom"===t.dir?90:270:"right"===t.dir?180:"left"===t.dir?0:"bottom"===t.dir?270:90}}class o{constructor(t){this.t=t}add(t,e){const n=this.t.append("path",{templateKey:"path",start:{position:o.i(t),dir:t.dir},end:{position:o.i(e),dir:e.dir?e.dir:o.o(t.dir)}});n.start=t,n.end=e,s(e,"connected"),o.h(t.shape,n),o.h(e.shape,n)}replaceEnd(i,r){const h=t(i.shape.connectedPaths,(t=>t.end===i));h.update({end:{position:o.i(r),dir:r.dir?r.dir:i.dir}}),h.end=r,i.shape!==r.shape&&(h.start.shape!==i.shape&&i.shape.connectedPaths.delete(h),o.h(r.shape,h)),e(i.shape.connectedPaths,(t=>t.start===i||t.end===i))||n(i,"connected"),s(r,"connected")}updatePosition(t){if(!e(t.connectedPaths))return;const s=t.postionGet();for(const e of t.connectedPaths)e.update({start:e.start.shape===t?{position:{x:s.x+e.start.innerPosition.x,y:s.y+e.start.innerPosition.y}}:null,end:e.end.shape===t?{position:{x:s.x+e.end.innerPosition.x,y:s.y+e.end.innerPosition.y}}:null})}deleteByShape(t){if(e(t.connectedPaths))for(const e of t.connectedPaths)e.end.shape.connectedPaths.delete(e),n(e.end,"connected"),e.start.shape.connectedPaths.delete(e),n(e.start,"connected"),e.end.shape.connectable&&this.t.delete(e.end.shape),this.t.delete(e)}startConnectorGet(e){return t(e.shape.connectedPaths,(t=>t.end===e)).start}static h(t,e){t.connectedPaths||(t.connectedPaths=new Set),t.connectedPaths.add(e)}static i(t){const e=t.shape.postionGet();return{x:e.x+t.innerPosition.x,y:e.y+t.innerPosition.y}}static o(t){switch(t){case"bottom":return"top";case"top":return"bottom";case"left":return"right";case"right":return"left"}}}class r extends EventTarget{constructor(t,e){super(),this.t=t.on("pointermove",this).on("pointerdown",this).on("pointerup",this).on("pointerenter",this).on("pointerleave",this),this.u=e}on(t,e){return this.addEventListener(t,e),this}shapeAdd(t){return this.t.append("shape",t)}shapeDel(t){this.u.deleteByShape(t),this.t.delete(t)}shapeConnect(t){this.u.add(t.start.shape.connectors.get(t.start.connector),t.end.shape.connectors.get(t.end.connector))}handleEvent(t){switch(t.type){case"pointermove":this.l&&(s(this.l,"disabled"),this.l.update({position:{x:this.p.x+t.detail.clientX,y:this.p.y+t.detail.clientY}}),this.u.updatePosition(this.l));break;case"pointerdown":switch(t.detail.target.type){case"canvas":case"shape":this.shapeSetMoving(t.detail.target,{x:t.detail.clientX,y:t.detail.clientY});break;case"connector":this.v(t)}break;case"pointerup":"connector"===t.detail.target.type&&this.m(t),this.g(),this.k();break;case"pointerenter":this.l&&this.l.connectable&&("connector"===t.detail.target.type||"shape"===t.detail.target.type)&&this._(t.detail.target);break;case"pointerleave":this.k()}}v(t){switch(t.detail.target.connectorType){case"out":{const e=this.shapeAdd(i(t.detail.target));this.shapeSetMoving(e,{x:t.detail.clientX,y:t.detail.clientY}),this.u.add(t.detail.target,e.defaultInConnector);break}case"in":if(t.detail.target.stateGet().has("connected")){if(!this.$("disconnect",{start:this.u.startConnectorGet(t.detail.target),end:t.detail.target}))return;const e=this.shapeAdd(i(t.detail.target));this.shapeSetMoving(e,{x:t.detail.clientX,y:t.detail.clientY}),this.u.replaceEnd(t.detail.target,e.defaultInConnector)}}}m(t){this.l&&this.l.connectable&&"in"===t.detail.target.connectorType&&this.$("connect",{start:this.u.startConnectorGet(this.l.defaultInConnector),end:t.detail.target})&&(this.u.replaceEnd(this.l.defaultInConnector,t.detail.target),this.shapeDel(this.l))}C(t){t!==this.S&&(this.$("select",{target:t}),this.S&&n(this.S,"selected"),t&&s(t,"selected"),this.S=t)}shapeSetMoving(t,e){this.l=t;const s=this.l.postionGet();this.p={x:s.x-e.x,y:s.y-e.y},this.C(this.l)}g(){this.l&&n(this.l,"disabled"),this.p=null,this.l=null}_(t){this.P=t,s(t,"hovered"),"connector"===t.type&&s(t.shape,"hovered")}k(){this.P&&(n(this.P,"hovered"),"connector"===this.P.type&&n(this.P.shape,"hovered"),this.P=null)}$(t,e){return this.dispatchEvent(new CustomEvent(t,{cancelable:!0,detail:e}))}}class h{constructor({svgEl:t,start:e,end:s}){this.svgEl=t,this.T=e,this.G=s,this.type="path",this.j()}update(t){t.start&&Object.assign(this.T,t.start),t.end&&Object.assign(this.G,t.end),this.j()}j(){this.svgEl.setAttribute("d",h.O(70,this.T,this.G))}static O(t,e,s){return`M ${e.position.x} ${e.position.y} C ${h.I(e.dir,e.position.x,t)} ${h.M(e.dir,e.position.y,t)}, ${h.I(s.dir,s.position.x,t)} ${h.M(s.dir,s.position.y,t)}, ${s.position.x} ${s.position.y}`}static I(t,e,s){return"right"===t||"left"===t?"right"===t?e+s:e-s:e}static M(t,e,s){return"right"===t||"left"===t?e:"bottom"===t?e+s:e-s}}function c(t,e,s){let n=function(t,e){for(const s of t)if(!e||e(s))return s;return null}(t.transform.baseVal,(t=>t.type===e));return n||(n=(t.ownerSVGElement||s).createSVGTransform(),t.transform.baseVal.appendItem(n)),n}function a(t){const e=c(t,SVGTransform.SVG_TRANSFORM_TRANSLATE).matrix;return{x:e.e,y:e.f}}class d{constructor({svgEl:t,type:e=null,connectable:s=null,defaultInConnector:n=null}){this.A=new Set,this.svgEl=t,this.type=e||"shape",this.connectable=s,this.defaultInConnector=n,this.connectors=new Map}on(t,e){return this.svgEl.addEventListener(t,e),this}stateHas(t){return this.A.has(t)}stateGet(){return new Set(this.A)}postionGet(){return a(this.svgEl)}update(t){var e,s,n;t.position&&(e=this.svgEl,s=t.position,c(e,SVGTransform.SVG_TRANSFORM_TRANSLATE,n).setTranslate(s.x,s.y)),t.rotate&&function(t,e,s){c(t,SVGTransform.SVG_TRANSFORM_ROTATE,s).setRotate(e,0,0)}(this.svgEl,t.rotate),t.props&&d.D(this.svgEl,t.props),t.state&&(this.A=t.state,this.A.has("selected")?this.svgEl.classList.add("selected"):this.svgEl.classList.remove("selected"),this.A.has("hovered")?this.svgEl.classList.add("hover"):this.svgEl.classList.remove("hover"),this.A.has("disabled")?this.svgEl.style.pointerEvents="none":this.svgEl.style.pointerEvents="auto")}static D(t,e){Object.keys(e).forEach((s=>{const n="root"===s?t:t.querySelector(`[data-key='${s}'`);Object.keys(e[s]).forEach((t=>{if("textContent"===t)n.innerHTML=(i=e[s][t]?e[s][t].toString():"",o={x:(r=n).x?.baseVal[0]?.value??0,lineHeight:parseInt(r.getAttribute("data-line-height"))},i.split("\n").map(((t,e)=>`<tspan x="${o.x}" dy="${0===e?".4em":`${o.lineHeight}px`}" ${0===t.length?'visibility="hidden"':""}>${0===t.length?".":function(t){return t.replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;")}(t).replaceAll(" ","&nbsp;")}</tspan>`)).join(""));else n.setAttribute(t,e[s][t].toString());var i,o,r}))}))}}class u extends EventTarget{constructor(t,e){super(),this.H=e,this.V=t,this.V.addEventListener("pointermove",this),this.V.addEventListener("pointerdown",this),this.V.addEventListener("pointerup",this),this.F=new WeakMap,this.K=t.querySelector('[data-key="canvas"]'),this.F.set(this.K,new d({svgEl:this.K,type:"canvas"}))}append(t,e){switch(t){case"shape":return this.H({svgCanvas:this.K,svgElemToPresenterObj:this.F,listener:this,createParams:e});case"path":return function({svgCanvas:t,createParams:e}){const s=t.ownerSVGElement.getElementsByTagName("defs")[0].querySelector(`[data-templ='${e.templateKey}']`).cloneNode(!0);return t.append(s),new h({svgEl:s,start:e.start,end:e.end})}({svgCanvas:this.K,createParams:e})}}delete(t){this.F.delete(t.svgEl),t.svgEl.remove()}on(t,e){return this.addEventListener(t,e),this}handleEvent(t){switch(t.stopPropagation(),t.type){case"pointermove":this.q(t),this.$(t,"pointermove",null);break;case"pointerdown":this.$(t,t.type,t.target.hasAttribute("data-no-click")?document.elementsFromPoint(t.clientX,t.clientY)[1]:t.currentTarget);break;case"pointerup":{const e=document.elementsFromPoint(t.clientX,t.clientY);this.$(t,t.type,e[0].hasAttribute("data-no-click")?e[1]:e[0]);break}}}q(t){const e=document.elementFromPoint(t.clientX,t.clientY);e!==this.B&&(this.B&&this.$(t,"pointerleave",this.B),e&&this.$(t,"pointerenter",e),this.B=e)}$(t,e,s){let n=null;s&&(n=this.F.get(s===this.V||s.ownerSVGElement!==this.V?this.K:s),n||(n=this.F.get(s.closest("[data-connect]"))),n||(n=this.F.get(s.closest("[data-templ]")))),this.dispatchEvent(new CustomEvent(e,{detail:{target:n,clientX:t.clientX,clientY:t.clientY}}))}}class l{constructor({svgEl:t,connectorType:e,shape:s,key:n,innerPosition:i,dir:o}){this.L=t,this.A=new Set,this.type="connector",this.connectorType=e,this.shape=s,this.key=n,this.innerPosition=i,this.dir=o}stateHas(t){return this.A.has(t)}stateGet(){return new Set(this.A)}update(t){this.A=t.state,this.A.has("connected")?this.L.classList.add("connected"):this.L.classList.remove("connected"),this.A.has("hovered")?this.L.classList.add("hover"):this.L.classList.remove("hover")}}function p(t,e){return new l({svgEl:t,connectorType:"in"===t.getAttribute("data-connect")?"in":"out",shape:e,key:t.getAttribute("data-key"),innerPosition:v(t),dir:t.getAttribute("data-connect-dir")})}function v(t){if(!t.getAttribute("data-connect-point"))return null;const e=t.getAttribute("data-connect-point").split(",");return{x:parseFloat(e[0]),y:parseFloat(e[1])}}function f(t,e){const s=new u(t,(function(t){let s=function(t,e){const s=t.ownerSVGElement.getElementsByTagName("defs")[0].querySelector(`[data-templ='${e.templateKey}']`).cloneNode(!0);t.append(s);const n=new d({svgEl:s});if(!e.postionIsIntoCanvas){const s=a(t);e.position.x-=s.x,e.position.y-=s.y}return n.update(e),n}(t.svgCanvas,t.createParams);return e&&(s=e(s,t)),t.svgElemToPresenterObj.set(s.svgEl,s),function(t,e,s){s.connectable="true"===s.svgEl.getAttribute("data-connectable"),v(s.svgEl)&&(s.defaultInConnector=p(s.svgEl,s)),s.svgEl.addEventListener("pointerdown",t),s.svgEl.querySelectorAll("[data-connect]").forEach((n=>{const i=p(n,s);n.addEventListener("pointerdown",t),e.set(n,i),s.connectors.set(i.key,i)})),e.set(s.svgEl,s)}(t.listener,t.svgElemToPresenterObj,s),s}));return new r(s,new o(s))}export{f as svgDiagramCreate};
