!function(){"use strict";function t(t,e){if(!t)return null;let i;for(const n of t)e&&!e(n)||(i=n);return i}function e(t,e){if(!t)return!1;for(const i of t)if(!e||e(i))return!0;return!1}function i(t,e,i){let n=function(t,e){for(const i of t)if(!e||e(i))return i;return null}(t.transform.baseVal,(t=>t.type===e));return n||(n=(t.ownerSVGElement||i).createSVGTransform(),t.transform.baseVal.appendItem(n)),n}function n(t,e,n){i(t,SVGTransform.SVG_TRANSFORM_TRANSLATE,n).setTranslate(e.x,e.y)}function s(t){const e=i(t,SVGTransform.SVG_TRANSFORM_TRANSLATE).matrix;return{x:e.e,y:e.f}}function o(t,e,i){t.innerHTML=function(t,e,i){return t.split("\n").map(((t,n)=>`<tspan x="${e}" dy="${0===n?".4em":`${i}px`}" ${0===t.length?'visibility="hidden"':""}>${0===t.length?".":function(t){return t.replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;")}(t).replaceAll(" ","&nbsp;")}</tspan>`)).join("")}(e,t.x?.baseVal[0]?.value??0,i.lineHeight),null!=i.verticalMiddle&&(t.y.baseVal[0].value=i.verticalMiddle-t.getBBox().height/2)}class h{constructor({svgEl:t,type:e=null,connectable:i=null,defaultInConnector:n=null}){this.o=new Set,this.svgEl=t,this.type=e||"shape",this.connectable=i,this.defaultInConnector=n,this.connectors=new Map}stateHas(t){return this.o.has(t)}stateGet(){return new Set(this.o)}positionGet(){return s(this.svgEl)}update(t){t.position&&n(this.svgEl,t.position),t.rotate&&function(t,e,n){i(t,SVGTransform.SVG_TRANSFORM_ROTATE,n).setRotate(e,0,0)}(this.svgEl,t.rotate),t.props&&h.h(this.svgEl,t.props),t.connectors&&Object.keys(t.connectors).forEach((e=>{const i=t.connectors[e],n=this.connectors.get(e);i.innerPosition&&(n.innerPosition=i.innerPosition),i.dir&&(n.dir=i.dir)})),t.state&&(this.o=t.state,this.o.has("selected")?this.svgEl.classList.add("selected"):this.svgEl.classList.remove("selected"),this.o.has("hovered")?this.svgEl.classList.add("hover"):this.svgEl.classList.remove("hover"),this.o.has("disabled")?this.svgEl.style.pointerEvents="none":this.svgEl.style.pointerEvents="auto")}static h(t,e){Object.keys(e).forEach((i=>{const n="root"===i?t:t.querySelector(`[data-key='${i}'`);Object.keys(e[i]).forEach((t=>{if("textContent"===t)o(n,e[i][t]?.toString(),a(n));else n.setAttribute(t,e[i][t].toString())}))}))}}function a(t){return{lineHeight:parseInt(t.getAttribute("data-line-height")),verticalMiddle:t.hasAttribute("data-vertical-middle")?parseInt(t.getAttribute("data-vertical-middle")):null}}function r(t,e,i,n,s){const o=t.getBBox(),h=o.width+20;e.width.baseVal.value=h+2*n+2,e.x.baseVal.value=o.x-n-("center"===s?10:0),e.height.baseVal.value=o.height+2*n+3,e.y.baseVal.value=o.y-n,i.style.width=`${h}px`,i.style.height=`${o.height}px`}function c(t,e,i,n,s){let h;switch(i.tagName){case"tspan":h=t.querySelector(`[data-text-for=${i.parentElement.getAttribute("data-key")}]`);break;case"text":h=t.querySelector(`[data-text-for=${i.getAttribute("data-key")}]`);break;default:i.getAttribute("data-text-for")&&(h=i)}if(!h)return;h.classList.remove("empty");const c=h.getAttribute("data-text-for"),d=t.querySelector(`[data-key=${c}]`);return function(t,e,i,n,s){const h=document.createElementNS("http://www.w3.org/2000/svg","foreignObject"),a=document.createElement("textarea");a.style.caretColor=t.getAttribute("fill"),a.value=i,a.oninput=function(){o(t,a.value,e),r(t,h,a,d,c.textAlign),n(a.value)},a.onblur=function(){s(a.value)},a.onpointerdown=function(t){t.stopImmediatePropagation()},h.appendChild(a),t.parentElement.appendChild(h);const c=getComputedStyle(a),d=parseInt(c.padding)+parseInt(c.borderWidth);return r(t,h,a,d,c.textAlign),a.focus(),h}(d,a(d),e[c]?.textContent.toString(),(t=>{n(d,{[c]:{textContent:t}})}),(t=>{t?h.classList.remove("empty"):h.classList.add("empty"),s()}))}class d extends class{constructor(t){this.p=t,this.p.svgEl.addEventListener("click",this),this.svgEl=this.p.svgEl,this.type=this.p.type,this.connectable=this.p.connectable,this.defaultInConnector=this.p.defaultInConnector,this.connectors=this.p.connectors}stateHas(t){return this.p.stateHas(t)}stateGet(){return this.p.stateGet()}positionGet(){return this.p.positionGet()}update(t){t.position&&(this.u=!1),t.state&&(t.state.has("selected")&&!this.stateGet().has("selected")&&(this.u=!0),this.m&&(this.m=!1,this.onEditLeave())),this.p.update(t)}handleEvent(t){t.target.hasAttribute("data-no-click")||document.elementFromPoint(t.clientX,t.clientY)!==t.target||(t.stopPropagation(),this.u||this.m||(this.m=!0,this.onEdit(t)),this.u=!1,this.onClick(t,this.m))}onEdit(t){}onEditLeave(){}onClick(t,e){}}{constructor(t,e){super(t),this.g=Object.assign({},e)}on(t,e){return this.svgEl.addEventListener(t,e),this}update(t){var e,i;t.props&&Object.assign(this.g,t.props),t.state&&t.state.has("selected")&&!this.stateGet().has("selected")&&(e=this.svgEl,i=this.g,e.querySelectorAll("[data-text-for]").forEach((t=>{i[t.getAttribute("data-text-for")]?.textContent||t.classList.add("empty")}))),super.update(t)}onEdit(t){this.v()}onClick(t,e){e&&this.k(t)}onEditLeave(){this.C(),this.M()}k(t){this.H||(this.H=c(this.svgEl,this.g,t.target,((t,e)=>{Object.assign(this.g,e),this.onTextChange(t,e)}),(t=>{this.C()})))}onTextChange(t,e){this.svgEl.dispatchEvent(new CustomEvent("txtUpd",{detail:{target:this,props:e}}))}C(){this.H&&!this.P&&(this.P=!0,this.H.remove(),this.H=null,this.P=!1)}v(){if(this.$)return;const t=document.createElement("div");t.classList.add("pop-set"),t.style.position="fixed",t.innerHTML='<style>.pop-set{position:fixed;padding:10px;box-shadow:0 0 58px 2px rgb(34 60 80 / 20%);border-radius:16px;background-color:rgba(255,255,255,.9)}</style><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24"><path fill="none" d="M0 0h24v24H0z"/><path d="M17 6h5v2h-2v13a1 1 0 0 1-1 1H5a1 1 0 0 1-1-1V8H2V6h5V3a1 1 0 0 1 1-1h8a1 1 0 0 1 1 1v3zm1 2H6v12h12V8zm-9 3h2v6H9v-6zm4 0h2v6h-2v-6zM9 4v2h6V4H9z" fill="rgba(52,71,103,1)"/></svg>',t.onclick=t=>{this.M(),this.svgEl.dispatchEvent(new CustomEvent("del",{detail:{target:this}}))},this.$=t,this.panelUpdPos(),document.body.append(t)}panelUpdPos(){if(!this.$)return;const t=this.svgEl.getBoundingClientRect();this.$.style.top=t.top-35+"px",this.$.style.left=`${t.left+10}px`}M(){this.$&&(this.$.remove(),this.$=null)}}function l(t,e){if(!t.stateHas(e)){const i=t.stateGet();t.update({state:i.add(e)})}}function p(t,e){if(t.stateHas(e)){const s=t.stateGet();t.update({state:(i=s,n=e,i.delete(n),i)})}var i,n}function u(t){const e=t.shape.positionGet(),i=t.innerPosition;return{templateKey:"connect-end",position:{x:e.x+i.x,y:e.y+i.y},postionIsIntoCanvas:!0,rotate:"out"===t.connectorType?"right"===t.dir?0:"left"===t.dir?180:"bottom"===t.dir?90:270:"right"===t.dir?180:"left"===t.dir?0:"bottom"===t.dir?270:90}}class m{constructor(t){this._=t}add(t,e){const i=this._.append("path",{templateKey:"path",start:{position:m.V(t),dir:t.dir},end:{position:m.V(e),dir:e.dir?e.dir:m.L(t.dir)}});i.start=t,i.end=e,l(e,"connected"),m.S(t.shape,i),m.S(e.shape,i)}replaceEnd(i,n){const s=t(i.shape.connectedPaths,(t=>t.end===i));s.update({end:{position:m.V(n),dir:n.dir?n.dir:i.dir}}),s.end=n,i.shape!==n.shape&&(s.start.shape!==i.shape&&i.shape.connectedPaths.delete(s),m.S(n.shape,s)),e(i.shape.connectedPaths,(t=>t.start===i||t.end===i))||p(i,"connected"),l(n,"connected")}updatePosition(t){if(!e(t.connectedPaths))return;const i=t.positionGet();for(const e of t.connectedPaths)e.update({start:e.start.shape===t?{position:{x:i.x+e.start.innerPosition.x,y:i.y+e.start.innerPosition.y}}:null,end:e.end.shape===t?{position:{x:i.x+e.end.innerPosition.x,y:i.y+e.end.innerPosition.y}}:null})}deleteByShape(t){if(e(t.connectedPaths))for(const e of t.connectedPaths)e.end.shape.connectedPaths.delete(e),p(e.end,"connected"),e.start.shape.connectedPaths.delete(e),p(e.start,"connected"),e.end.shape.connectable&&this._.delete(e.end.shape),this._.delete(e)}startConnectorGet(e){return t(e.shape.connectedPaths,(t=>t.end===e)).start}static S(t,e){t.connectedPaths||(t.connectedPaths=new Set),t.connectedPaths.add(e)}static V(t){const e=t.shape.positionGet();return{x:e.x+t.innerPosition.x,y:e.y+t.innerPosition.y}}static L(t){switch(t){case"bottom":return"top";case"top":return"bottom";case"left":return"right";case"right":return"left"}}}class f extends EventTarget{constructor(t,e){super(),this._=t.on("pointermove",this).on("pointerdown",this).on("pointerup",this).on("pointerenter",this).on("pointerleave",this),this.T=e}on(t,e){return this.addEventListener(t,e),this}shapeAdd(t){const e=this._.append("shape",t);return this.D("add",{target:e}),e}shapeUpdate(t,e){t.update(e),(e.position||e.connectors)&&this.T.updatePosition(t)}shapeDel(t){this.T.deleteByShape(t),this._.delete(t)}shapeConnect(t){this.T.add(t.start.shape.connectors.get(t.start.connector),t.end.shape.connectors.get(t.end.connector))}handleEvent(t){switch(t.type){case"pointermove":this.O&&(l(this.O,"disabled"),this.O.update({position:{x:this.U.x+t.detail.clientX,y:this.U.y+t.detail.clientY}}),this.T.updatePosition(this.O));break;case"pointerdown":switch(t.detail.target.type){case"canvas":case"shape":this.shapeSetMoving(t.detail.target,{x:t.detail.clientX,y:t.detail.clientY});break;case"connector":this.A(t)}break;case"pointerup":"connector"===t.detail.target.type&&this.j(t),this.B(),this.G();break;case"pointerenter":this.O&&this.O.connectable&&("connector"===t.detail.target.type||"shape"===t.detail.target.type)&&this.I(t.detail.target);break;case"pointerleave":this.G()}}A(t){switch(t.detail.target.connectorType){case"out":{const e=this.shapeAdd(u(t.detail.target));this.shapeSetMoving(e,{x:t.detail.clientX,y:t.detail.clientY}),this.T.add(t.detail.target,e.defaultInConnector);break}case"in":if(t.detail.target.stateGet().has("connected")){if(!this.D("disconnect",{start:this.T.startConnectorGet(t.detail.target),end:t.detail.target}))return;const e=this.shapeAdd(u(t.detail.target));this.shapeSetMoving(e,{x:t.detail.clientX,y:t.detail.clientY}),this.T.replaceEnd(t.detail.target,e.defaultInConnector)}}}j(t){this.O&&this.O.connectable&&"in"===t.detail.target.connectorType&&this.D("connect",{start:this.T.startConnectorGet(this.O.defaultInConnector),end:t.detail.target})&&(this.T.replaceEnd(this.O.defaultInConnector,t.detail.target),this.shapeDel(this.O))}R(t){t!==this.F&&(this.D("select",{target:t}),this.F&&p(this.F,"selected"),t&&l(t,"selected"),this.F=t)}shapeSetMoving(t,e){this.O=t;const i=this.O.positionGet();this.U={x:i.x-e.x,y:i.y-e.y},this.R(this.O)}B(){this.O&&p(this.O,"disabled"),this.U=null,this.O=null}I(t){this.K=t,l(t,"hovered"),"connector"===t.type&&l(t.shape,"hovered")}G(){this.K&&(p(this.K,"hovered"),"connector"===this.K.type&&p(this.K.shape,"hovered"),this.K=null)}D(t,e){return this.dispatchEvent(new CustomEvent(t,{cancelable:!0,detail:e}))}}class g{constructor({svgEl:t,start:e,end:i}){this.svgEl=t,this.N=e,this.X=i,this.type="path",this.J()}update(t){t.start&&Object.assign(this.N,t.start),t.end&&Object.assign(this.X,t.end),this.J()}J(){this.svgEl.setAttribute("d",g.Y(70,this.N,this.X))}static Y(t,e,i){return`M ${e.position.x} ${e.position.y} C ${g.Z(e.dir,e.position.x,t)} ${g.q(e.dir,e.position.y,t)}, ${g.Z(i.dir,i.position.x,t)} ${g.q(i.dir,i.position.y,t)}, ${i.position.x} ${i.position.y}`}static Z(t,e,i){return"right"===t||"left"===t?"right"===t?e+i:e-i:e}static q(t,e,i){return"right"===t||"left"===t?e:"bottom"===t?e+i:e-i}}class v extends EventTarget{constructor(t,e){super(),this.W=e,this.tt=t,this.tt.addEventListener("pointermove",this),this.tt.addEventListener("pointerdown",this),this.tt.addEventListener("pointerup",this),this.et=new WeakMap,this.it=t.querySelector('[data-key="canvas"]'),this.et.set(this.it,new h({svgEl:this.it,type:"canvas"}))}append(t,e){switch(t){case"shape":return this.W({svgCanvas:this.it,svgElemToPresenterObj:this.et,listener:this,createParams:e});case"path":return function({svgCanvas:t,createParams:e}){const i=t.ownerSVGElement.getElementsByTagName("defs")[0].querySelector(`[data-templ='${e.templateKey}']`).cloneNode(!0);return t.append(i),new g({svgEl:i,start:e.start,end:e.end})}({svgCanvas:this.it,createParams:e})}}delete(t){this.et.delete(t.svgEl),t.svgEl.remove()}on(t,e){return this.addEventListener(t,e),this}handleEvent(t){switch(t.stopPropagation(),t.type){case"pointermove":this.nt(t),this.D(t,"pointermove",null);break;case"pointerdown":this.D(t,t.type,t.target.hasAttribute("data-no-click")?document.elementsFromPoint(t.clientX,t.clientY)[1]:t.currentTarget);break;case"pointerup":{const e=document.elementsFromPoint(t.clientX,t.clientY);this.D(t,t.type,e[0].hasAttribute("data-no-click")?e[1]:e[0]);break}}}nt(t){const e=document.elementFromPoint(t.clientX,t.clientY);e!==this.st&&(this.st&&this.D(t,"pointerleave",this.st),e&&this.D(t,"pointerenter",e),this.st=e)}D(t,e,i){let n=null;i&&(n=this.et.get(i===this.tt||i.ownerSVGElement!==this.tt?this.it:i),n||(n=this.et.get(i.closest("[data-connect]"))),n||(n=this.et.get(i.closest("[data-templ]")))),this.dispatchEvent(new CustomEvent(e,{detail:{target:n,clientX:t.clientX,clientY:t.clientY}}))}}class x{constructor({svgEl:t,connectorType:e,shape:i,key:n,innerPosition:s,dir:o}){this.ot=t,this.o=new Set,this.type="connector",this.connectorType=e,this.shape=i,this.key=n,this.innerPosition=s,this.dir=o}stateHas(t){return this.o.has(t)}stateGet(){return new Set(this.o)}update(t){this.o=t.state,this.o.has("connected")?this.ot.classList.add("connected"):this.ot.classList.remove("connected"),this.o.has("hovered")?this.ot.classList.add("hover"):this.ot.classList.remove("hover")}}function w(t,e){return new x({svgEl:t,connectorType:"in"===t.getAttribute("data-connect")?"in":"out",shape:e,key:t.getAttribute("data-key"),innerPosition:y(t),dir:t.getAttribute("data-connect-dir")})}function y(t){if(!t.getAttribute("data-connect-point"))return null;const e=t.getAttribute("data-connect-point").split(",");return{x:parseFloat(e[0]),y:parseFloat(e[1])}}function b(t,e){const i=new v(t,(function(t){if(!t.createParams.postionIsIntoCanvas){const e=s(t.svgCanvas);t.createParams.position.x-=e.x,t.createParams.position.y-=e.y}let i=function(t,e){const i=t.ownerSVGElement.getElementsByTagName("defs")[0].querySelector(`[data-templ='${e.templateKey}']`).cloneNode(!0);return t.append(i),new h({svgEl:i})}(t.svgCanvas,t.createParams);return e&&(i=e(i,t)),t.svgElemToPresenterObj.set(i.svgEl,i),function(t,e,i){i.connectable="true"===i.svgEl.getAttribute("data-connectable"),y(i.svgEl)&&(i.defaultInConnector=w(i.svgEl,i)),i.svgEl.addEventListener("pointerdown",t),i.svgEl.querySelectorAll("[data-connect]").forEach((n=>{const s=w(n,i);n.addEventListener("pointerdown",t),e.set(n,s),i.connectors.set(s.key,s)})),e.set(i.svgEl,i)}(t.listener,t.svgElemToPresenterObj,i),i.update(t.createParams),i}));return new f(i,new m(i))}function k(t,e=0){const i=t.x-e,n=t.x+t.width+e,s=t.y-e,o=t.y+t.height+e;return[{x:i,y:s},{x:n,y:s},{x:i,y:o},{x:n,y:o}]}function E(t,e,i){return i<=t?t:t+Math.ceil((i-t)/e)*e}class C extends d{constructor(t,e,i){super(e,i),this.ht=t,this.at=60}update(t){super.update(t),void 0!==t.props?.text?.textContent&&this.rt(this.svgEl.querySelector('[data-key="text"]'))}onTextChange(t,e){super.onTextChange(t,e),this.rt(t)}rt(t){let e=0;for(const i of t.getElementsByTagName("tspan"))for(const t of k(i.getBBox())){const i=t.x**2+t.y**2;i>e&&(e=i)}const i=E(60,20,Math.sqrt(e));i!==this.at&&(this.at=i,this.ct(i),this.panelUpdPos())}ct(t){const e=-1*t;this.ht.shapeUpdate(this,{props:{main:{r:t},outer:{r:t+20},outright:{cx:t},outleft:{cx:e},outbottom:{cy:t},outtop:{cy:e},"inright-empty":{cx:t},"inright-not-empty":{x:e},"inleft-empty":{cx:e},"inleft-not-empty":{x:e},"inbottom-empty":{cy:t},"inbottom-not-empty":{x:e},"intop-empty":{cy:e},"intop-not-empty":{x:e}},connectors:{outright:{innerPosition:{x:t,y:0}},outleft:{innerPosition:{x:e,y:0}},outbottom:{innerPosition:{x:0,y:t}},outtop:{innerPosition:{x:0,y:e}},inright:{innerPosition:{x:t,y:0}},inleft:{innerPosition:{x:e,y:0}},inbottom:{innerPosition:{x:0,y:t}},intop:{innerPosition:{x:0,y:e}}}})}}class M extends d{constructor(t,e,i){super(e,i),this.ht=t,this.dt=150,this.lt=150,this.ut=50,this.ft=50}update(t){super.update(t),void 0!==t.props?.text?.textContent&&this.rt(this.svgEl.querySelector('[data-key="text"]'))}onTextChange(t,e){super.onTextChange(t,e),this.rt(t)}rt(t){let e=0;for(const i of t.getElementsByTagName("tspan")){const t=i.getBBox().width+4;t>e&&(e=t)}const i=E(this.lt,40,e),n=E(this.ft,20,t.getBBox().height+4);i===this.dt&&n===this.ut||(this.dt=i,this.ut=n,this.ct(i,n),this.panelUpdPos())}ct(t,e){const i=z(this.lt,this.ft,t,e),n={r:{cx:t+i.x,cy:e/2+i.y},l:{cx:i.x,cy:e/2+i.y},b:{cx:t/2+i.x,cy:e+i.y},t:{cx:t/2+i.x,cy:i.y}};this.ht.shapeUpdate(this,{props:{main:i,outer:z(this.lt,this.ft,t+40,e+40),outright:n.r,outleft:n.l,outbottom:n.b,outtop:n.t,"inright-empty":n.r,"inright-not-empty":{x:-1*n.r.cx,y:-1*n.r.cy},"inleft-empty":n.l,"inleft-not-empty":{x:n.l.cx,y:n.r.cy},"inbottom-empty":n.b,"inbottom-not-empty":{x:-1*n.b.cy,y:n.b.cx},"intop-empty":n.t,"intop-not-empty":{x:n.t.cy,y:-1*n.t.cx}},connectors:{outright:{innerPosition:{x:n.r.cx,y:n.r.cy}},outleft:{innerPosition:{x:n.l.cx,y:n.l.cy}},outbottom:{innerPosition:{x:n.b.cx,y:n.b.cy}},outtop:{innerPosition:{x:n.t.cx,y:n.t.cy}},inright:{innerPosition:{x:n.r.cx,y:n.r.cy}},inleft:{innerPosition:{x:n.l.cx,y:n.l.cy}},inbottom:{innerPosition:{x:n.b.cx,y:n.b.cy}},intop:{innerPosition:{x:n.t.cx,y:n.t.cy}}}})}}function z(t,e,i,n){return{y:(e-n)/2,x:(t-i)/2,width:i,height:n}}function H(t,e,i){const n=t.ownerSVGElement.createSVGPoint();return n.x=e,n.y=i,t.isPointInFill(n)||t.isPointInStroke(n)}class P extends d{constructor(t,e,i){super(e,i),this.ht=t,this.gt=120}update(t){super.update(t),void 0!==t.props?.text?.textContent&&this.rt(this.svgEl.querySelector('[data-key="text"]'))}onTextChange(t,e){super.onTextChange(t,e),this.rt(t)}rt(t){this.vt||(this.vt=function(t,e){const i=t.querySelector(`[data-key="${e}"]`),n=i.cloneNode(!1);return n.style.fill="transparent",n.style.stroke="transparent",n.removeAttribute("data-key"),t.insertBefore(n,i),n}(this.svgEl,"main"));const i=function(t,e,i,n){let s=i;if(n(s)){do{s+=e}while(n(s));return s}if(t===s)return null;do{s-=e}while(t<=s&&!n(s));return s+=e,i!==s?s:null}(120,40,this.gt,(i=>(this.vt.setAttribute("d",_(120,70,i)),function(t,i,n=0){return e(t.getElementsByTagName("tspan"),(t=>{const e=t.getBBox(),s=e.x-n,o=e.x+e.width+n,h=e.y-n,a=e.y+e.height+n;return!(H(i,s,h)&&H(i,o,h)&&H(i,s,a)&&H(i,o,a))}))}(t,this.vt))));i&&(this.gt=i,this.ct(i),this.panelUpdPos())}ct(t){const e=$(120,70,t+16);this.ht.shapeUpdate(this,{props:{main:{d:_(120,70,t)},outer:{d:_(120,70,t+80)},outleft:{cx:e.l.x},outright:{cx:e.r.x},outtop:{cy:e.t.y},outbottom:{cy:e.b.y},"inleft-empty":{cx:e.l.x},"inleft-not-empty":{x:e.l.x},"inright-empty":{cx:e.r.x},"inright-not-empty":{x:-1*e.r.x},"intop-empty":{cy:e.t.y},"intop-not-empty":{x:e.t.y},"inbottom-empty":{cy:e.b.y},"inbottom-not-empty":{x:-1*e.b.y}},connectors:{outleft:{innerPosition:e.l},outright:{innerPosition:e.r},outtop:{innerPosition:e.t},outbottom:{innerPosition:e.b},inleft:{innerPosition:e.l},inright:{innerPosition:e.r},intop:{innerPosition:e.t},inbottom:{innerPosition:e.b}}})}onEditLeave(){super.onEditLeave(),this.vt&&(this.vt.remove(),this.vt=null)}}function $(t,e,i){const n=(i-t)/2,s=-1*n;return{l:{x:s,y:e/2},t:{x:t/2,y:s},r:{x:t+n,y:e/2},b:{x:t/2,y:e+n}}}function _(t,e,i){const n=$(t,e,i);return`M${n.l.x} ${n.l.y} L${n.t.x} ${n.t.y} L${n.r.x} ${n.r.y} L${n.b.x} ${n.b.y} Z`}async function V(t,e,i){return function(t,e,i){let n,s;const o=L(t,e);if(o)n=new DataView(t,0,o.byteOffset-8),s=new DataView(t,o.byteOffset+o.byteLength+4);else{const e=t.byteLength-12;n=new DataView(t,0,e),s=new DataView(t,e)}const h=new DataView(new ArrayBuffer(8));return h.setUint32(0,i.length),h.setUint32(4,e),new Blob([n,h,i,new Uint32Array([0]),s],{type:"image/png"})}(await t.arrayBuffer(),S(e),i)}function L(t,e){const i=new DataView(t,8);let n,s=0,o=i.getUint32(4);for(;1229278788!==o;){if(n=i.getUint32(s),o===e)return new DataView(t,s+16,n);s=s+12+n,o=i.getUint32(s+4)}return null}function S(t){return new DataView((new TextEncoder).encode(t).buffer).getUint32(0)}async function T(t){const e=await async function(t,e){return L(await t.arrayBuffer(),S(e))}(t,"dgRm");return e?(new TextDecoder).decode(e):null}function D(t,e,i){const o=t.cloneNode(!0);o.querySelectorAll(".selected").forEach((t=>t.classList.remove("selected")));const h=function(t,e){let i;for(const n of t.querySelectorAll(e)){i||(i={top:1/0,left:1/0,bottom:-1/0,right:-1/0});const t=n.getBoundingClientRect();t.top<i.top&&(i.top=t.top),t.left<i.left&&(i.left=t.left),t.right>i.right&&(i.right=t.right),t.bottom>i.bottom&&(i.bottom=t.bottom)}return i?{x:i.left,y:i.top,height:i.bottom-i.top,width:i.right-i.left}:null}(t,'[data-key="canvas"]'),a=o.querySelector('[data-key="canvas"]'),r=s(a);n(a,{x:-1*h.x+r.x+15,y:-1*h.y+r.y+15}),function(t,e,i,n){const s=new Image;s.width=e.width*i*window.devicePixelRatio,s.height=e.height*i*window.devicePixelRatio,s.onload=function(){const t=document.createElement("canvas");t.width=s.width,t.height=s.height,t.style.width=`${s.width}px`,t.style.height=`${s.height}px`;const i=t.getContext("2d");i.imageSmoothingEnabled=!1,i.drawImage(s,e.x,e.y,e.width,e.height,0,0,s.width,s.height),URL.revokeObjectURL(s.src),t.toBlob(n,"image/png")},t.width.baseVal.newValueSpecifiedUnits(SVGLength.SVG_LENGTHTYPE_PX,s.width),t.height.baseVal.newValueSpecifiedUnits(SVGLength.SVG_LENGTHTYPE_PX,s.height),s.src=URL.createObjectURL(new Blob([(new XMLSerializer).serializeToString(t)],{type:"image/svg+xml;charset=utf-8"}))}(o,{x:0,y:0,height:h.height+30,width:h.width+30},3,i?async function(t){e(await V(t,"dgRm",(new TextEncoder).encode(i)))}:e)}const O={pngCreate(t){const e=this.dataGet();e?D(this.svg,t,JSON.stringify(e)):t(null)},async pngLoad(t){const e=await T(t);return!!e&&(this.dataSet(JSON.parse(e)),!0)}};class U extends EventTarget{constructor(t,e){super(),this.svg=t,this.xt=new Map,this.wt=[],this.ht=e.on("connect",this).on("disconnect",this).on("add",this)}handleEvent(t){switch(t.type){case"add":t.detail.target.on("txtUpd",this).on("del",this);break;case"txtUpd":this.xt.get(t.detail.target).detail=t.detail.props.text.textContent;break;case"del":this.yt(t.detail.target);break;case"connect":this.wt.push(t.detail);break;case"disconnect":this.wt.splice(this.wt.findIndex((e=>{return i=e,n=t.detail,i.start.shape===n.start.shape&&i.start.key===n.start.key&&i.end.shape===n.end.shape&&i.end.key===n.end.key;var i,n})),1)}}yt(t){this.ht.shapeDel(t),this.xt.delete(t),this.wt=this.wt.filter((e=>e.start.shape!==t&&e.end.shape!==t))}shapeAdd(t){const e=this.ht.shapeAdd(t);return this.xt.set(e,{templateKey:t.templateKey,detail:t.props.text?.textContent}),this.dispatchEvent(new CustomEvent("shapeAdd",{cancelable:!0,detail:e})),e}shapeUpdate(t,e){this.ht.shapeUpdate(t,e)}shapeSetMoving(t,e){this.ht.shapeSetMoving(t,e)}clear(){for(const t of this.xt)this.yt(t[0])}dataGet(){if(!this.xt||0===this.xt.size)return null;const t={s:[]},e=new Map;for(const i of this.xt)i[1].position=i[0].positionGet(),e.set(i[0],t.s.push(i[1])-1);return this.wt&&this.wt.length>0&&(t.c=this.wt.map((t=>({s:{i:e.get(t.start.shape),c:t.start.key},e:{i:e.get(t.end.shape),c:t.end.key}})))),t}dataSet(t){if(this.clear(),!(t.s&&t.s.length>0))return;const e=[];for(const i of t.s){const t=this.shapeAdd({templateKey:i.templateKey,position:i.position,props:{text:{textContent:i.detail}}});e.push(t)}if(t.c&&t.c.length>0)for(const i of t.c)this.ht.shapeConnect({start:{shape:e[i.s.i],connector:i.s.c},end:{shape:e[i.e.i],connector:i.e.c}}),this.wt.push({start:{type:"connector",key:i.s.c,shape:e[i.s.i]},end:{type:"connector",key:i.e.c,shape:e[i.e.i]}})}on(t,e){return this.addEventListener(t,e),this}}Object.assign(U.prototype,O);class A extends HTMLElement{connectedCallback(){const t=this.attachShadow({mode:"closed"});t.innerHTML='<style>.menu{overflow-x:auto;padding:0;position:fixed;bottom:15px;left:50%;transform:translateX(-50%);box-shadow:0 0 58px 2px rgba(34,60,80,.2);border-radius:16px;background-color:rgba(255,255,255,.9)}.content{white-space:nowrap;display:flex}[data-cmd]{cursor:pointer}.menu svg{height:42px;display:inline-block;padding:15px 10px;stroke:#344767;stroke-width:2px;fill:#fff;width:42px;min-width:42px}.menu .big{width:62px;min-width:62px}@media only screen and (max-width:700px){.menu{width:100%;border-radius:0;bottom:0;display:flex;flex-direction:column}.content{align-self:center}}</style><div id="menu" class="menu" style="touch-action:none"><div class="content"><svg data-cmd="shapeAdd" data-cmd-arg="circle" style="padding-left:20px"><circle r="20" cx="21" cy="21"></circle></svg> <svg data-cmd="shapeAdd" data-cmd-arg="rect" class="big"><rect x="1" y="1" width="60" height="40" rx="15" ry="15"></rect></svg> <svg data-cmd="shapeAdd" data-cmd-arg="rhomb" class="big"><g transform="translate(1,1)"><path d="M0 20 L30 0 L60 20 L30 40 Z" stroke-width="2" stroke-linejoin="round"></path></g></svg> <svg data-cmd="shapeAdd" data-cmd-arg="text"><text x="5" y="40" font-size="52px" fill="#344767" stroke-width="0">T</text></svg></div></div>';const e=t.getElementById("menu");e.querySelectorAll('[data-cmd="shapeAdd"]').forEach((t=>t.addEventListener("pointerdown",this))),e.addEventListener("pointerleave",this),e.addEventListener("pointerup",this),e.addEventListener("pointermove",this)}init(t){this.bt=new j(t)}handleEvent(t){switch(t.type){case"pointerdown":this.kt=!1,this.Et=!1,this.Ct=t.currentTarget.getAttribute("data-cmd-arg"),this.Mt=document.elementFromPoint(t.clientX,t.clientY),this.st=this.Mt;break;case"pointerup":this.kt=!1,this.Et=!1,this.Ct=null;break;case"pointermove":this.zt(t),!this.kt&&this.Et&&this.bt.shapeMoveMobile({clientX:t.clientX,clientY:t.clientY});break;case"pointerleave":this.kt=!0,this.Ht(t)}}zt(t){if(!this.Ct)return;const e=document.elementFromPoint(t.clientX,t.clientY);e!==this.st&&(this.Mt===this.st&&this.Ht(t),this.st=e)}Ht(t){this.Ct&&(this.bt.shapeDragOut({shape:this.Ct,clientX:t.clientX,clientY:t.clientY}),this.Ct=null,this.Et=!0)}}customElements.define("ap-menu-shape",A);class j{constructor(t){this.ht=t}shapeDragOut(t){const e=this.ht.svg.querySelector(`[data-templ='${t.shape}']`).getAttribute("data-center").split(",");this.Pt={x:parseFloat(e[0]),y:parseFloat(e[1])},this.$t=this.ht.shapeAdd({templateKey:t.shape,position:{x:t.clientX-this.Pt.x,y:t.clientY-this.Pt.y},props:{text:{textContent:"Title"}}}),this.ht.shapeSetMoving(this.$t,{x:t.clientX,y:t.clientY});const i=this.$t.positionGet();this._t={x:t.clientX-this.Pt.x-i.x,y:t.clientY-this.Pt.y-i.y}}shapeMoveMobile(t){this.ht.shapeUpdate(this.$t,{position:{x:t.clientX-this.Pt.x-this._t.x,y:t.clientY-this.Pt.y-this._t.y}})}}class B extends HTMLElement{connectedCallback(){const t=this.attachShadow({mode:"closed"});t.innerHTML='<style>.menu{position:fixed;top:15px;left:15px;cursor:pointer}.options{position:fixed;padding:15px;box-shadow:0 0 58px 2px rgb(34 60 80 / 20%);border-radius:16px;background-color:rgba(255,255,255,.9);top:0;left:0}.options a,.options div{color:#0d6efd;cursor:pointer;margin:10px 0;display:flex;align-items:center;line-height:25px;text-decoration:none}.options a svg,.options div svg{margin-right:10px}</style><svg data-cmd="menu" class="menu" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24"><path fill="none" d="M0 0h24v24H0z"/><path d="M3 4h18v2H3V4zm0 7h18v2H3v-2zm0 7h18v2H3v-2z" fill="rgba(52,71,103,1)"/></svg><div class="options" style="visibility:hidden"><svg data-cmd="menu" class="menu" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24"><path fill="none" d="M0 0h24v24H0z"/><path d="M3 4h18v2H3V4zm0 7h18v2H3v-2zm0 7h18v2H3v-2z" fill="rgba(52,71,103,1)"/></svg><div data-cmd="new" style="padding-top:30px"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24"><path fill="none" d="M0 0h24v24H0z"/><path d="M9 2.003V2h10.998C20.55 2 21 2.455 21 2.992v18.016a.993.993 0 0 1-.993.992H3.993A1 1 0 0 1 3 20.993V8l6-5.997zM5.83 8H9V4.83L5.83 8zM11 4v5a1 1 0 0 1-1 1H5v10h14V4h-8z" fill="rgba(52,71,103,1)"/></svg>New diagram</div><div data-cmd="open"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24"><path fill="none" d="M0 0h24v24H0z"/><path d="M3 21a1 1 0 0 1-1-1V4a1 1 0 0 1 1-1h7.414l2 2H20a1 1 0 0 1 1 1v3h-2V7h-7.414l-2-2H4v11.998L5.5 11h17l-2.31 9.243a1 1 0 0 1-.97.757H3zm16.938-8H7.062l-1.5 6h12.876l1.5-6z" fill="rgba(52,71,103,1)"/></svg>Open diagram image</div><div data-cmd="save"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24"><path fill="none" d="M0 0h24v24H0z"/><path d="M3 19h18v2H3v-2zm10-5.828L19.071 7.1l1.414 1.414L12 17 3.515 8.515 4.929 7.1 11 13.17V2h2v11.172z" fill="rgba(52,71,103,1)"/></svg>Save diagram image</div><div data-cmd="link"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24"><path fill="none" d="M0 0h24v24H0z"/><path d="M13.06 8.11l1.415 1.415a7 7 0 0 1 0 9.9l-.354.353a7 7 0 0 1-9.9-9.9l1.415 1.415a5 5 0 1 0 7.071 7.071l.354-.354a5 5 0 0 0 0-7.07l-1.415-1.415 1.415-1.414zm6.718 6.011l-1.414-1.414a5 5 0 1 0-7.071-7.071l-.354.354a5 5 0 0 0 0 7.07l1.415 1.415-1.415 1.414-1.414-1.414a7 7 0 0 1 0-9.9l.354-.353a7 7 0 0 1 9.9 9.9z" fill="rgba(52,71,103,1)"/></svg>Copy link to diagram</div><a href="/donate.html" target="_blank"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24"><path fill="none" d="M0 0H24V24H0z"/><path d="M12.001 4.529c2.349-2.109 5.979-2.039 8.242.228 2.262 2.268 2.34 5.88.236 8.236l-8.48 8.492-8.478-8.492c-2.104-2.356-2.025-5.974.236-8.236 2.265-2.264 5.888-2.34 8.244-.228zm6.826 1.641c-1.5-1.502-3.92-1.563-5.49-.153l-1.335 1.198-1.336-1.197c-1.575-1.412-3.99-1.35-5.494.154-1.49 1.49-1.565 3.875-.192 5.451L12 18.654l7.02-7.03c1.374-1.577 1.299-3.959-.193-5.454z" fill="rgba(255,66,77,1)"/></svg>Donate</a></div>',t.querySelectorAll("[data-cmd]").forEach((t=>t.addEventListener("click",this))),this.Vt=t.querySelector(".options")}init(t){this.ht=t,this.ht.svg.addEventListener("dragover",(t=>{t.preventDefault()})),this.ht.svg.addEventListener("drop",(async e=>{e.preventDefault(),1===e.dataTransfer?.items?.length&&"file"===e.dataTransfer.items[0].kind&&"image/png"===e.dataTransfer.items[0].type&&await t.pngLoad(e.dataTransfer.items[0].getAsFile())||this.Lt()}))}async handleEvent(t){switch(this.St(),t.currentTarget.getAttribute("data-cmd")){case"new":this.ht.clear();break;case"open":!function(t,e){const i=document.createElement("input");i.type="file",i.multiple=!1,i.accept=t,i.onchange=async function(){e(i.files?.length?i.files[0]:null)},i.click(),i.remove()}(".png",(async t=>{await this.ht.pngLoad(t)||this.Lt()}));break;case"save":this.ht.pngCreate((t=>{t?function(t,e){const i=document.createElement("a");i.download=e,i.href=URL.createObjectURL(t),i.click(),URL.revokeObjectURL(i.href),i.remove()}(t,"dgrm.png"):alert("Diagram is empty")}));break;case"link":{const t=this.ht.dataGet();if(!t)return void alert("Diagram is empty");const e=new URL(window.location.href);e.hash=encodeURIComponent(JSON.stringify(t)),await navigator.clipboard.writeText(e.toString()),alert("Link to diagram copied to clipboard");break}}}St(){this.Vt.style.visibility="visible"===this.Vt.style.visibility?"hidden":"visible"}Lt(){alert("File cannot be read. Use the exact image file you got from the application.")}}customElements.define("ap-file-options",B);const G=document.getElementById("diagram"),I=new U(G,function(t){const e=b(t,((t,i)=>{switch(i.createParams.templateKey){case"circle":return new C(e,t,i.createParams.props);case"rhomb":return new P(e,t,i.createParams.props);case"rect":return new M(e,t,i.createParams.props);default:return new d(t,i.createParams.props)}}));return e}(G)).on("shapeAdd",(function(){document.getElementById("tip")?.remove()}));document.getElementById("file-options").init(I),document.getElementById("menu-shape").init(I),window.location.hash&&(I.dataSet(JSON.parse(decodeURIComponent(window.location.hash.substring(1)))),history.replaceState(null,null," "))}();
