const t=(t,n)=>t.querySelector(`[data-key="${n}"]`),n=t=>document.getElementById(t);function e(t,n){t.style.transform=`translate(${n.x}px, ${n.y}px)`}const o=(t,...n)=>t?.classList.add(...n),i=(t,...n)=>t?.classList.remove(...n),a=(t,n)=>t?.classList.contains(n),s=(t,n,e,o)=>(t.addEventListener(n,e,{passive:!0,once:o}),e),c=(t,n,e,o)=>t?.removeEventListener(n,e,{capture:o});function r(t,n,e){t.querySelectorAll(n).forEach((t=>{t.onclick=e}))}const l=(t,n)=>t.currentTarget.getAttribute(n),d=t=>"TEXTAREA"===t.target.tagName.toUpperCase(),h=t=>"mouse"===t.pointerType;function u(t,n){const e=document.createElementNS("http://www.w3.org/2000/svg",t);return n&&(e.innerHTML=n),e}const p=t=>t.parentElement.appendChild(t);function f(t){let n,e=0;for(const o of t.getElementsByTagName("tspan"))for(const t of v(o.getBBox())){const o=Math.abs(t.x)+Math.abs(t.y);e<o&&(n=t,e=o)}return n}const v=t=>[{x:t.x,y:t.y},{x:t.right,y:t.y},{x:t.x,y:t.bottom},{x:t.right,y:t.bottom}],g=async(t,n)=>{const e=await fetch(t,{method:"POST",headers:{"Content-Type":"application/json;charset=utf-8"},body:D(n)});if(!e.ok)throw new Error;return e},m=(t,n)=>{const e=new URL(window.location.href);return e.searchParams.set(t,n),e.toString()},w=t=>{const n=new URL(window.location.href);n.searchParams.delete(t),history.replaceState(null,null,n.toString())},y=t=>new URL(window.location.href).searchParams.get(t);function x(t,n,e,o){function i(n){c(t,"pointercancel",i),c(t,"pointerup",i),c(t,"wheel",i),c(document,"pointerdown",i),c(t,"pointermove",e),o(n)}s(t,"pointercancel",i,!0),s(t,"pointerup",i,!0),s(t,"wheel",i,!0),s(document,"pointerdown",i,!0),s(t,"pointermove",e),t.setPointerCapture(n.pointerId)}function b(t,n){const e=()=>{c(t.ownerSVGElement,"pointercancel",o),c(t.ownerSVGElement,"wheel",o),c(t.ownerSVGElement,"pointerdown",o)},o=o=>{"pointerdown"===o.type&&t.contains(o.target)||(e(),n(o))};return s(t.ownerSVGElement,"pointercancel",o,!0),s(t.ownerSVGElement,"wheel",o,!0),s(t.ownerSVGElement,"pointerdown",o,!0),e}const k=(t,n)=>new CustomEvent(t,{detail:n,cancelable:!1}),M=(t,n)=>t.dispatchEvent(n),H=(t,n)=>{let e,o,i=!1;return function a(){if(i)return e=arguments,void(o=this);t.apply(this,arguments),i=!0,setTimeout((function(){i=!1,e&&(a.apply(o,e),e=o=null)}),n)}};function $(t,n,e){return t??=0,e<=t?t:t+Math.ceil((e-t)/n)*n}function C(t,n){for(let e=t.length-1;e>=0;--e)n(t[e])}const z=t=>t.values().next().value;function V(t,n,e){const o=e??1;return t.x+=o*n.x,t.y+=o*n.y,t}const L=(t,n)=>({x:t.x+n,y:t.y+n}),B=(t,n)=>S(t,n.x,n.y),S=(t,n,e)=>(t.x=n,t.y=e,t),T=t=>({x:t.x,y:t.y}),E=(t,n)=>t?.x===n?.x&&t?.y===n?.y;function Z(){const t=new Uint8Array(4);return window.crypto.getRandomValues(t),Array.from(t,(t=>t.toString(16).padStart(2,"0"))).join("")}const A=t=>P(D(t)),D=t=>JSON.stringify(t),P=t=>JSON.parse(t),U=(t,n,e,o)=>{let i,a;const s=()=>{a=setTimeout((async t=>{await e(),i||s()}),t)};s();const c=setTimeout((t=>{r(),o&&o()}),n),r=()=>{i=!0,clearTimeout(a),clearTimeout(c)};return r};function R(t,n,e){t.x+=e[O]/n,t.y+=e[j]/n}const O=Symbol("movementX"),j=Symbol("movementY"),I=Symbol("Canvas"),F=(t,n,e)=>({x:(n-t.position.x)/t.scale,y:(e-t.position.y)/t.scale}),K=(t,n)=>F(t,n.clientX,n.clientY);function N(t,n){const e=n/2;function o(t){const o=Math.round(t/n)*n;return t-o>=0?o+e:o-e}return t.x=o(t.x),t.y=o(t.y),t}function Y(t){return{x:t.clientX,y:t.clientY}}function G(t,n){return{id:t.pointerId,pos:Y(t),shift:{x:n.position.x-t.clientX,y:n.position.y-t.clientY}}}let X,J;function _(t){t&&!X?(X=document.createElement("div"),X.style.cssText="z-index: 2; position: fixed; left: 0; top: 0; width:100%; height:100%; background: #fff; opacity: 0",X.innerHTML="<style>@keyframes blnk{0%{opacity:0}50%{opacity:.7}100%{opacity:0}}.blnk{animation:blnk 1.6s linear infinite}</style>",X.classList.add("blnk"),document.body.append(X)):t||(X?.remove(),X=null)}function q(t,n,e){const o=t=>{"pointerdown"===t.type&&i.contains(t.target)&&!t.target.hasAttribute("ap-close")||(c(document,"wheel",o),c(document,"pointerdown",o),c(document,"pointercancel",o),i?.del())};s(document,"wheel",o,!0),s(document,"pointercancel",o,!0),s(document,"pointerdown",o);const i=function(t,n,e){function o(t,n){J&&(J.style.left=`${t}px`,J.style.top=window.scrollY+n-J.getBoundingClientRect().height+"px")}return J=document.createElement("div"),J.style.cssText="position: fixed; left: 50%; top: 30%; box-shadow: 0 4px 24px rgba(0,0,0,.12); border-radius: 8px; background-color: rgb(255,255,255);",J.append(t),document.body.append(J),null!=n?o(n,e):J.style.transform="translate(-50%, -30%)",{position:o,contains:t=>J?.contains(t),del:()=>{J?.remove(),J=null}}}(t,n,e);return i}function W(t){const n=document.createElement("div");n.style.cssText="\n\t\tmin-width: 150px;\n\t\tbackground-color: rgb(52,71,103);\n\t\tcolor: #fff;\n\t\ttext-align: center;\n\t\tborder-radius: 8px;\n\t\tpadding: 10px;\n\t\tposition: fixed;\n\t\tz-index: 1;\n\t\tleft: 50%;\n\t\ttop: 30px;\n\t\ttransform: translate(-50%, -30%)",n.className="toast",n.innerHTML=`<style>.toast{visibility:visible;animation:fadein .5s,fadeout .5s 2.5s}@keyframes fadein{from{top:0;opacity:0}to{top:30px;opacity:1}}@keyframes fadeout{from{top:30px;opacity:1}to{top:0;opacity:0}}</style>${t}`,document.body.append(n),setTimeout((t=>n.remove()),2800)}const Q="https://dgrm.boyko.tech/api/s",tt=(t,n)=>g(`${Q}/${t}`,n);function nt(t){return ot(t).find((t=>!t.hasAttribute("data-evt-no")))}function et(t){return ot(t)[0]}function ot(t){return document.elementsFromPoint(t.clientX,t.clientY).sort(((t,n)=>{const e=t.getAttribute("data-evt-index"),o=n.getAttribute("data-evt-index");return e===o?0:e>o?-1:1}))}const it=Symbol("path"),at=Symbol("shape"),st="1.2",ct=t=>{return n=t.s,!Object.keys(n).length;var n},rt=t=>lt([...t.children],!1);function lt(t,n,e){const o={v:st,s:{}},i=new Map,a=t=>{let e=i.get(t);if(!e){const a=A(t[at].data);n&&(a.id=Z(),e=a.id),i.set(t,e),o.s[a.id]=a}return e},s=i=>{if(o.s[i[it].data.id])return;const s=o=>{return n?(i=o.shape?.shapeEl,-1!==t.indexOf(i)?{s:a(o.shape.shapeEl),k:o.shape.connectorKey}:{p:A(o.data)}):o.shape?(e&&a(o.shape.shapeEl),{s:o.shape.shapeEl[at].data.id,k:o.shape.connectorKey}):{p:A(o.data)};var i},c=i[it].data,r={id:n?Z():c.id,type:0,s:s(c.s),e:s(c.e)};c.styles&&(r.c=A(c.styles)),o.s[r.id]=r};for(const n of t)n[at]?(a(n),e&&n[at].paths?.forEach(s)):s(n);return o}function dt(t){return{v:st,s:{[t.id]:0!==t.type?t:(n=t,{id:n.id,type:0,s:{p:n.s.data},e:{p:n.e.data},c:n.styles})}};var n}const ht=(t,n)=>ut(t,"1.1"===n.v?function(t){const n={v:st,s:{}};return t.s.forEach(((t,e)=>{switch(t.type){case 0:{const o=t,i={id:e.toString(),type:0,c:o.c?.map((t=>"d-"+t)),s:{s:o.s.s?.toString(),k:o.s.k,p:o.s.p},e:{s:o.e.s?.toString(),k:o.e.k,p:o.e.p}};n.s[i.id]=i;break}default:{const o=t;o.id=e.toString(),o.styles=o.styles?.map((t=>"d-"+t)),n.s[o.id]=o;break}}})),n}(n):n);function ut(t,e){if(e.v!==st)return alert("Wrong format"),null;const o=new Map;function i(n){let e=o.get(n);return e||(e=ft(t,n),o.set(n,e)),e}const a=t=>e.s[t]?i(e.s[t]):n(t),s=[];for(const n in e.s)if(0===e.s[n].type)s.push(vt(t,e.s[n],a));else i(e.s[n]);return[...o.values(),...s]}function pt(t,e){const o=n(e.id);return o?((o[at]||o[it]).patch(e),o):t[I].shapeMap[e.type].create(e)}const ft=(t,n)=>pt(t,A(n)),vt=(t,n,e)=>pt(t,function(t,n){const e=t=>t.p?{data:{dir:t.p.dir,position:T(t.p.position)}}:{shape:{shapeEl:n(t.s),connectorKey:t.k}};return{type:0,id:t.id,styles:t.c,s:e(t.s),e:e(t.e)}}(n,e));const gt=(t,n,e)=>M(t,mt(n,e)),mt=(t,n)=>k("dgrmc",{newIds:t,shapesToCreateData:n}),wt=(t,n)=>k("dgrmd",{delIds:t,shapesToDelData:n}),yt=(t,n,e)=>M(t,xt(n,e)),xt=(t,n)=>k("dgrmu",{shapesBeforeUpdData:t,shapesToUpdData:n});function bt(t,n,e,o){const i=V(((t,n,e)=>{const o=F(t,n,e);return N(o,t.cell),o})(t[I].data,e,o),function(t){const n=function(t){const n={x:1/0,y:1/0},e={x:-1/0,y:-1/0};return kt(t,(t=>{t&&(n.x>t.x&&(n.x=t.x),n.y>t.y&&(n.y=t.y),e.x<t.x&&(e.x=t.x),e.y<t.y&&(e.y=t.y))})),{min:n,max:e}}(t);return{x:n.min.x+(n.max.x-n.min.x)/2,y:n.min.y+(n.max.y-n.min.y)/2}}(n),-1);kt(n,(n=>{n&&N(V(n,i),t[I].data.cell)}))}function kt(t,n){for(const e in t.s)0===t.s[e].type?(n(t.s[e].s.p?.position),n(t.s[e].e.p?.position)):n(t.s[e].position)}const Mt=(t,n)=>t[I].select(Ht(t,lt(n,!0),!0));function Ht(t,n,e,o,i){return bt(t,n,null==o?window.innerWidth/2:o,null==i?window.innerHeight/2:i),e&&gt(t,Object.keys(n.s),A(n)),t[I].select(null),ut(t,n)}function $t(t,n){((t,n,e)=>{M(t,wt(n,e))})(t,n.map((t=>(t[at]||t[it]).data.id)),lt(n,!1,!0)),n.forEach((t=>(t[at]||t[it]).del()))}function Ct(n){for(const o in n.cons)e(t(n.el,o),n.cons[o].position)}function zt(t,n){const e=t.getBoundingClientRect(),o=q(n,e.left+10,e.top+10);return{del:o.del,updPos:()=>{const n=t.getBoundingClientRect();o.position(n.left+10,n.top+10)}}}const Vt=(t,n)=>q(t,n.clientX-66,n.clientY-10),Lt=(t,n,e)=>{const o=lt([n],!1,!1);(n[at]??n[it]).patch(e),yt(t,o,lt([n],!1,!1))};function Bt(t,n){!function(t,n){const e=t.el[at].data;null!=n.title&&e.title!==n.title&&(e.title=n.title,t.drawTxt());n.styles&&(e.styles=n.styles,Tt(t.el))}(t,n);const e=n.position&&!E(t.el[at].data.position,n.position);return e&&B(t.el[at].data.position,n.position),e}const St=t=>t.forEach((t=>{const e=n(t);e&&(e[at]||e[it]).del()}));function Tt(t){const n=(t[at]??t[it]).data;n.styles||(n.styles=[]),C(t.classList,(n=>{n?.startsWith("d-")&&t.classList.remove(n)})),o(t,...n.styles)}const Et=(t,n,e)=>{const o=(n[at]??n[it]).data;o.styles||(o.styles=[]);const i={styles:A(o.styles)};Lt(t,n,function(t,n){const e=t.styles.findIndex((t=>t.startsWith("d-cl-")));e>-1&&t.styles.splice(e,1);n&&t.styles.push(n);return t}(i,e))};class Zt extends HTMLElement{constructor(t,n){super(),this.o=n,this.g=t}connectedCallback(){const t=t=>this.o[it].data.styles?.includes(t)?'class="actv"':"",n=this.attachShadow({mode:"closed"});n.innerHTML=`<style>.ln{display:flex}.ln>*{height:24px;padding:10px;fill-opacity:.3;stroke-opacity:.3}[data-cmd]{cursor:pointer}.actv{fill-opacity:1;stroke-opacity:1}</style><ap-shape-edit id="edit" edit-btn="true"><div class="ln"><svg data-cmd data-cmd-arg="d-arw-s" ${t("d-arw-s")} viewBox="0 0 24 24" width="24" height="24"><path fill="none" d="M0 0h24v24H0z"/><path d="M7.828 11H20v2H7.828l5.364 5.364-1.414 1.414L4 12l7.778-7.778 1.414 1.414z" fill="rgb(52,71,103)"/></svg> <svg data-cmd data-cmd-arg="d-arw-e" ${t("d-arw-e")} viewBox="0 0 24 24" width="24" height="24"><path fill="none" d="M0 0h24v24H0z"/><path d="M16.172 11l-5.364-5.364 1.414-1.414L20 12l-7.778 7.778-1.414-1.414L16.172 13H4v-2z" fill="rgb(52,71,103)"/></svg> <svg data-cmd data-cmd-arg="d-dash" ${t("d-dash")} viewBox="0 0 24 24" width="24" height="24"><path d="M 2,11 L 20,11" stroke="rgb(52,71,103)" style="stroke-dasharray:4,3;stroke-width:3"></path></svg></div></ap-shape-edit>`,s(n.getElementById("edit"),"cmd",(t=>{switch(t.detail.cmd){case"style":Et(this.g,this.o,t.detail.arg);break;case"del":$t(this.g,[this.o]);break;case"copy":Mt(this.g,[this.o])}})),r(n,"[data-cmd]",(t=>{const n=l(t,"data-cmd-arg"),e={styles:this.o[it].data.styles?A(this.o[it].data.styles):[]},a=e.styles.indexOf(n);a>-1?(e.styles.splice(a,1),i(t.currentTarget,"actv")):(e.styles.push(n),o(t.currentTarget,"actv")),Lt(this.g,this.o,e)}))}}customElements.define("ap-path-settings",Zt);const At='<svg data-cmd="del" viewBox="0 0 24 24" width="24" height="24"><path fill="none" d="M0 0h24v24H0z"/><path d="M17 6h5v2h-2v13a1 1 0 0 1-1 1H5a1 1 0 0 1-1-1V8H2V6h5V3a1 1 0 0 1 1-1h8a1 1 0 0 1 1 1v3zm1 2H6v12h12V8zm-9 3h2v6H9v-6zm4 0h2v6h-2v-6zM9 4v2h6V4H9z" fill="rgb(52,71,103)"/></svg>',Dt='<svg data-cmd="copy" viewBox="0 0 24 24" width="24" height="24"><path fill="none" d="M0 0h24v24H0z"/><path d="M7 6V3a1 1 0 0 1 1-1h12a1 1 0 0 1 1 1v14a1 1 0 0 1-1 1h-3v3c0 .552-.45 1-1.007 1H4.007A1.001 1.001 0 0 1 3 21l.003-14c0-.552.45-1 1.007-1H7zM5.003 8L5 20h10V8H5.003zM9 6h8v10h2V4H9v2z" fill="rgb(52,71,103)"/></svg>',Pt='<svg viewBox="0 0 24 24" width="24" height="24"><path fill="none" d="M0 0h24v24H0z"/><path d="M3 19h18v2H3v-2zm10-5.828L19.071 7.1l1.414 1.414L12 17 3.515 8.515 4.929 7.1 11 13.17V2h2v11.172z" fill="rgb(52,71,103)"/></svg>';function Ut(t,n,e,o){const i=Kt(t,n);i.shape={shapeEl:e,connectorKey:o},jt(t,i)}function Rt(t,n,e){const o=Kt(t,n);o.shape.shapeEl!==Nt(t,o)&&It(t,o),o.shape=null,o.data={dir:o.data.dir,position:e}}function Ot(t,n){const e=t[it].data,o=o=>{const i=e[o],a=n[o];i.shape?null==a.shape||i.shape.shapeEl===a.shape.shapeEl&&i.shape.connectorKey===a.shape.connectorKey?a.data&&Rt(t,o,a.data.position):function(t,n,e,o){const i=Kt(t,n);if(i.shape.shapeEl===e&&i.shape.connectorKey===o)return;i.shape.shapeEl!==e&&i.shape.shapeEl!==Nt(t,i)&&It(t,i);i.shape={shapeEl:e,connectorKey:o},jt(t,i)}(t,o,a.shape.shapeEl,a.shape.connectorKey):null!=a.shape?Ut(t,o,a.shape.shapeEl,a.shape.connectorKey):B(i.data.position,a.data.position)};o("s"),o("e")}function jt(t,n){n.data=Ft(n.shape).pathAdd(n.shape.connectorKey,t)}const It=(t,n)=>Ft(n.shape)?.pathDel(t),Ft=t=>t?.shapeEl[at],Kt=(t,n)=>t[it].data[n],Nt=(t,n)=>(t[it].data.e===n?t[it].data.s:t[it].data.e).shape?.shapeEl;function Yt(n,e){const a=u("g",'<path data-key="outer" d="M0 0" stroke="transparent" stroke-width="20" fill="none"/><path data-key="path" class="path" d="M0 0" stroke="#495057" stroke-width="1.8" fill="none" style="pointer-events:none"/><path data-key="selected" d="M0 0" stroke="transparent" stroke-width="10" fill="none" style="pointer-events:none"/><g data-key="start"><circle data-evt-index="1" class="path-end" r="10" stroke-width="0" fill="transparent"/><path class="path arr" d="M 0 0 -8 -4 -8 4 z" stroke="#495057" stroke-width="1.8" fill="#495057" style="pointer-events:none"></path></g><g data-key="end"><circle data-evt-index="1" class="path-end" r="10" stroke-width="0" fill="transparent"/><path class="path arr" d="M 0 0 -8 -4 -8 4 z" stroke="#495057" stroke-width="1.8" fill="#495057" style="pointer-events:none"></path></g>');a.id=e.id,o(a,"shpath"),e.s.el=t(a,"start"),e.e.el=t(a,"end"),e.styles=e.styles??["d-arw-e"];const s=Qt(a,"path","outer","selected");function c(){if(!e.s.shape||!e.e.shape){const t=function(t,n){const e=Math.atan2(n.y-t.y,n.x-t.x);return tn(e,-.8,.8)?"left":tn(e,.8,2.4)?"top":tn(e,2.4,3.2)||tn(e,-3.2,-2.4)?"right":"bottom"}(e.s.data.position,e.e.data.position);e.e.shape||(e.e.data.dir=t),e.s.shape||(e.s.data.dir=Wt(t))}const t=function(t){let n=.5*Math.hypot(t.s.data.position.x-t.e.data.position.x,t.s.data.position.y-t.e.data.position.y);function e(t){return"right"===t.dir||"left"===t.dir?"right"===t.dir?t.position.x+n:t.position.x-n:t.position.x}function o(t){return"right"===t.dir||"left"===t.dir?t.position.y:"bottom"===t.dir?t.position.y+n:t.position.y-n}n=n>70?70:n<15?15:n;const i=(n,e,o,i)=>t.styles.includes(o)?n.position[e]+(i[n.dir]??0):n.position[e],a=(t,n)=>i(t,"x",n,{left:-6,right:6}),s=(t,n)=>i(t,"y",n,{top:-6,bottom:6});return`M ${a(t.s.data,"d-arw-s")} ${s(t.s.data,"d-arw-s")} C ${e(t.s.data)} ${o(t.s.data)}, ${e(t.e.data)} ${o(t.e.data)}, ${a(t.e.data,"d-arw-e")} ${s(t.e.data,"d-arw-e")}`}(e);s.forEach((n=>n.setAttribute("d",t))),Jt(e.s),Jt(e.e)}let r,l;let d,f=0;function v(t){switch(f){case 0:f=1,o(a,"s"===l?"highlight-s":"e"===l?"highlight-e":"select"),_t(e.s,2),_t(e.e,2),p(a);break;case 1:f=2,d=b(a,(t=>g(!0))),function(t){r||(r=Vt(new Zt(n,a),t))}(t)}}function g(t){t||(l=null),f=0,i(a,"select","highlight-s","highlight-e"),_t(e.s,1),_t(e.e,1),r?.del(),r=null,d&&(d(),d=null)}return a[it]={data:e,drawPosition:c,click:(t,n)=>{if(0===f||l){const o=n||t?nn(e,n??nt(t)):null;en(l,o)||g(),l=o}v(t)},patch:t=>{e.styles&&(e.styles=t.styles,Tt(a)),t.s&&Ot(a,t),c()},moveCapture:(t,o,i)=>{g(!0);const s=i?null:lt([a],!1,!0),r=t=>{g(!0),s?yt(n,s,lt([a],!1,!0)):gt(n,[e.id],lt([a],!1,!0)),h(t)||v()},l=nn(e,o);l?Xt(n,a,c,t,l,r):function(t,n,e,o,i){x(n,o,(o=>{!function(t,n,e,o){const i=n=>R(n,t.scale,o);Gt(n.s,i),n.s.shape?.shapeEl&&n.s.shape?.shapeEl===n.e.shape?.shapeEl||Gt(n.e,i);n.s.shape||n.e.shape||e()}(t[I].data,n[it].data,e,o)}),(o=>{!function(t,n,e){const o=n=>N(n,t.cell);Gt(n.s,o),Gt(n.e,o),n.s.shape&&n.e.shape||e()}(t[I].data,n[it].data,e),i(o)}))}(n,a,c,t,r)},unselect:g,del:function(){g(),It(a,e.s),It(a,e.e),a.remove()}},e.styles&&o(a,...e.styles),e.s.shape&&jt(a,e.s),e.e.shape&&jt(a,e.e),c(),a}function Gt(t,n){t.shape?(n(Ft(t.shape).data.position),Ft(t.shape).drawPosition()):n(t.data.position)}const Xt=(t,n,e,r,l,d)=>{n[it].data[l].shape&&Rt(n,l,K(t[I].data,r)),n.style.pointerEvents="none";const h=function(t){let n=null;function e(t){const e=et(t);if(n!==e){a(e,"hovertrack")&&o(e,"hover");let t=!1;a(e?.parentElement,"hovertrack")&&(o(e.parentElement,"hover"),t=!0),i(n,"hover"),n?.parentElement===e?.parentElement&&t||i(n?.parentElement,"hover"),n=e}}return s(t,"pointermove",e),function(){c(t,"pointermove",e),i(n,"hover"),i(n?.parentElement,"hover"),n=null}}(n.parentElement);x(n[it].data[l].el,r,(o=>{R(n[it].data[l].data.position,t[I].data.scale,o),e()}),(o=>{const i=et(o),a=i?.getAttribute("data-connect");a?Ut(n,l,i.parentElement,a):N(n[it].data[l].data.position,t[I].data.cell),e(),h(),n.style.pointerEvents="unset",d(o)}))};function Jt(t){t.el.style.transform=`translate(${t.data.position.x}px, ${t.data.position.y}px) rotate(${qt(t.data.dir)}deg)`}function _t(t,n){t.el.firstElementChild.setAttribute("data-evt-index",n.toString())}const qt=t=>"right"===t?180:"left"===t?0:"bottom"===t?270:90,Wt=t=>"left"===t?"right":"right"===t?"left":"top"===t?"bottom":"top";const Qt=(n,...e)=>e.map((e=>t(n,e))),tn=(t,n,e)=>n<=t&&t<=e,nn=(t,n)=>t.e.el.contains(n)?"e":t.s.el.contains(n)?"s":null,en=(t,n)=>!t||t===n;function on(t,n,e){const o=function(t,n){let e=0;return{s:t.split("\n").map(((t,o)=>(e=o,`<tspan x="${n}" dy="${0===o?.41:1}em" ${0===t.length?'visibility="hidden"':""}>${0===t.length?".":function(t){return t.replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;")}(t).replaceAll(" ","&nbsp;")}</tspan>`))).join(""),c:e}}(e||"",t.x?.baseVal[0]?.value??0);t.innerHTML=o.s,null!=n&&t.y.baseVal[0].newValueSpecifiedUnits(t.y.baseVal[0].SVG_LENGTHTYPE_EMS,o.c>0?n-o.c/2:n)}const an=(t,n)=>zt(n,cn(t,n)),sn=(t,n,e)=>Vt(cn(t,n),e);function cn(t,n){const e=new rn;return s(e,"cmd",(e=>{switch(e.detail.cmd){case"style":Et(t,n,e.detail.arg);break;case"del":$t(t,[n]);break;case"copy":Mt(t,[n])}})),e}class rn extends HTMLElement{connectedCallback(){const t=this.attachShadow({mode:"closed"});t.innerHTML=`<style>.ln{display:flex}.ln>*{height:24px;padding:10px;cursor:pointer}#prop{padding-bottom:10px}.crcl{width:25px;height:25px;border-radius:50%}</style><div id="pnl"><div id="clr" style="display:none"><div class="ln"><div data-cmd="style" data-cmd-arg="d-cl-red"><div class="crcl" style="background:#e74c3c"></div></div><div data-cmd="style" data-cmd-arg="d-cl-orange"><div class="crcl" style="background:#f60"></div></div><div data-cmd="style" data-cmd-arg="d-cl-green"><div class="crcl" style="background:#19bc9b"></div></div></div><div class="ln"><div data-cmd="style" data-cmd-arg="d-cl-blue"><div class="crcl" style="background:#1aaee5"></div></div><div data-cmd="style" data-cmd-arg="d-cl-dblue"><div class="crcl" style="background:#1d809f"></div></div><div data-cmd="style" data-cmd-arg="d-cl-dgray"><div class="crcl" style="background:#495057"></div></div></div></div><div id="prop" style="display:none"><slot id="slot"></slot></div></div><div class="ln"><svg data-toggle="clr" viewBox="0 0 24 24" width="24" height="24"><path fill="none" d="M0 0h24v24H0z"/><path d="M19.228 18.732l1.768-1.768 1.767 1.768a2.5 2.5 0 1 1-3.535 0zM8.878 1.08l11.314 11.313a1 1 0 0 1 0 1.415l-8.485 8.485a1 1 0 0 1-1.414 0l-8.485-8.485a1 1 0 0 1 0-1.415l7.778-7.778-2.122-2.121L8.88 1.08zM11 6.03L3.929 13.1 11 20.173l7.071-7.071L11 6.029z" fill="rgb(52,71,103)"/></svg> <svg data-toggle="prop" ${this.getAttribute("edit-btn")?"":'style="display: none;"'} viewBox="0 0 24 24" width="24" height="24"><path fill="none" d="M0 0h24v24H0z"/><path d="M12.9 6.858l4.242 4.243L7.242 21H3v-4.243l9.9-9.9zm1.414-1.414l2.121-2.122a1 1 0 0 1 1.414 0l2.829 2.829a1 1 0 0 1 0 1.414l-2.122 2.121-4.242-4.242z" fill="rgb(52,71,103)"/></svg> ${Dt} ${At}</div>`;{const n=t.getElementById("pnl");function e(t){var e;e=window.scrollY+t*n.getBoundingClientRect().height,J.style.top=`${J.getBoundingClientRect().top+e}px`}let o;r(t,"[data-toggle]",(n=>{o&&(e(1),ln(o,!1));const i=t.getElementById(l(n,"data-toggle"));o!==i?(ln(i,!0),e(-1),o=i):o=null}))}r(t,"[data-cmd]",(t=>{this.dispatchEvent(new CustomEvent("cmd",{detail:{cmd:l(t,"data-cmd"),arg:l(t,"data-cmd-arg")}}))}))}}function ln(t,n){t.style.display=n?"unset":"none"}function dn(n,e,o,i,a,s,c,r,l=0){const d=hn(e.id,o,i),h={el:t(d,"text"),vMid:l},u=()=>on(h.el,h.vMid,e.title);u();const f=un(n,d,e,i,(t=>{1===t&&p(d)}),h,r??an,(()=>c(h.el)),a,s,null);return{el:d,cons:i,draw:f.draw,drawTxt:u}}customElements.define("ap-shape-edit",rn);const hn=(t,n,e)=>{const o=u("g",`${n}\n\t${Object.entries(e).map((t=>`<circle data-key="${t[0]}" data-connect="${t[1].dir}" class="hovertrack" data-evt-index="2" r="10" cx="0" cy="0" style="transform:translate(${t[1].position.x}px,${t[1].position.y}px)"/>`)).join()}`);return o.id=t,o};function un(t,n,a,s,c,r,l,d,p,f,v){let g,m,w,y;a.styles??=[];const k=()=>lt([n],!1,!1);function M(t){a.title=t,d()}const H=function(t,n,a,s,c,r,l,d,p){o(n,"hovertrack");const f=A(s),v=new Set;let g,m,w=0;function y(){g?.remove(),g=null}function k(){n.style.transform=`translate(${a.position.x}px, ${a.position.y}px)`;for(const t in s)f[t].position={x:s[t].position.x+a.position.x,y:s[t].position.y+a.position.y};for(const t of v)t[it].drawPosition()}function M(){w=1,o(n,"select"),l&&(g=function(t,n){const i=u("circle");return i.setAttribute("data-evt-index","2"),o(i,"resizer"),e(i,n),t.append(i),i}(n,l()))}function H(t){r(),w=0,i(n,"select","highlight"),t||y(),m&&(m(),m=null)}const $=t=>{switch(w){case 0:M();break;case 1:w=2,i(n,"select"),o(n,"highlight"),y(),m=b(n,(t=>H()))}c(t,w)},C=(e,o,i)=>{if(o===g){H(!0);const o=lt([n],!1,!1);return void x(g,e,d,(e=>{p&&p(),y(),M(),yt(t,o,lt([n],!1,!1))}))}H();const a=o.getAttribute("data-connect");if(a){const o=Yt(t,{id:Z(),type:0,s:{shape:{shapeEl:n,connectorKey:a}},e:{data:{dir:Wt(f[a].dir),position:K(t[I].data,e)}}});return n.parentNode.append(o),t[I].select(h(e)?null:[o]),o[it].moveCapture(e,o[it].data.e.el,!0),void v.add(o)}z(e,i)},z=(e,o)=>{const i=o?null:lt([n],!1,!1);x(n,e,(n=>{R(a.position,t[I].data.scale,n),k()}),(e=>{N(a.position,t[I].data.cell),k(),i?yt(t,i,lt([n],!1,!1)):gt(t,[a.id],lt([n],!1)),h(e)||M()}))};return n[at]={data:a,drawPosition:k,click:$,moveCapture:C,unselect:H,del:function(){H();for(const t of v)t[it].del();n.remove()},paths:v,pathAdd:function(t,n){return v.add(n),f[t]},pathDel:function(t){v.delete(t)}},k}(t,n,a,s,((e,o)=>{c&&c(o),2===o&&(r&&!g&&(w=a.title,m=k(),g=function(t,n,e,o,i){let a=u("foreignObject");const s=document.createElement("textarea"),c=()=>function(t,n,e,o,i){const a=t.getBBox(),s=a.width+20;n.width.baseVal.value=s+2*o+2,n.x.baseVal.value=a.x-o-("center"===i?10:"right"===i?20:0),n.height.baseVal.value=a.height+2*o+3,n.y.baseVal.value=a.y-o,e.style.width=`${s}px`,e.style.height=`${a.height}px`}(t,a,s,l,r.textAlign);s.value=e||"",s.oninput=function(){on(t,n,s.value),o(s.value),c()},i&&(s.onblur=function(){i(s.value)}),s.onpointerdown=function(t){t.stopImmediatePropagation()},a.appendChild(s),t.parentElement.appendChild(a);const r=getComputedStyle(s),l=parseInt(r.paddingLeft)+parseInt(r.borderWidth);return c(),s.focus(),{dispose:()=>{a.remove(),a=null},draw:c}}(r.el,r.vMid,a.title,M)),y||(y=l(t,n,e)))}),(function(){g?.dispose(),g=null,y?.del(),y=null,m&&w!==a.title&&yt(t,m,k()),m=null,w=null}),p,f,v);return a.styles&&o(n,...a.styles),{draw:()=>{H(),y?.updPos&&y?.updPos(),g?.draw()}}}function pn(n,e,o){t(n,e).r.baseVal.value=o}const fn=(t,n)=>function(t,n,e){const o=f(t);return $(n,e,Math.sqrt(o.x**2+o.y**2))}(t,n,24);function vn(n,i){i.w??=96,i.h??=48;const a={w:i.w,h:i.h};let s;const c=dn(n,i,'<rect data-key="outer" data-evt-no data-evt-index="2" width="144" height="96" x="-72" y="-48" fill="transparent" stroke="transparent" stroke-width="0" />\n\t\t <rect data-key="main" width="96" height="48" x="-48" y="-24" rx="15" ry="15" fill="#1aaee5" stroke="#fff" stroke-width="1" />\n\t\t <text data-key="text" y="0" x="0" text-anchor="middle" style="pointer-events: none;" fill="#fff">&nbsp;</text>',{right:{dir:"right",position:{x:48,y:0}},left:{dir:"left",position:{x:-48,y:0}},bottom:{dir:"bottom",position:{x:0,y:24}},top:{dir:"top",position:{x:0,y:-24}}},(()=>{const t=function(t){const n=t.w/2,e=t.h/2;return{t:{x:t.position.x-n,y:t.position.y-e},b:{x:n,y:e}}}(i);return s=t.t,t.b}),(o=>{let l;(function(t,n,o,i,a){const s=V(K(t[I].data,i),n,-1),c={};let r=!1;function l(t){s[t]<48&&(s[t]=48);const e=48*Math.round(s[t]/48),i="x"===t?"w":"h";o[i]!==e&&(!a||a()[i]<=e)&&(o[i]=e,o.position[t]=n[t]+e/2,r=!0),c[t]=s[t]-o[i]/2}return l("x"),l("y"),e(i.target,c),r})(n,s,i,o,(()=>(l??=wn(t(c.el,"text")),l)))&&(mn(a,i),r())}),(t=>{const n=wn(t,a);gn(i,n)||(mn(i,n),r())}));function r(){!function(t,n){const e=n.w/-2,o=n.h/-2;t.cons.right.position.x=-e,t.cons.left.position.x=e,t.cons.bottom.position.y=-o,t.cons.top.position.y=o,Ct(t),yn(t.el,"main",n.w,n.h,e,o),yn(t.el,"outer",n.w+48,n.h+48,e-24,o-24)}(c,i),c.draw()}return o(c.el,"shrect"),96!==i.w||48!==i.h?r():c.draw(),c.el[at].patch=t=>{const n=Bt(c,t),e=(null!=t.w||null!=t.h)&&!gn(i,t);e&&mn(i,t),e?r():n&&c.draw()},c.el}const gn=(t,n)=>t.w===n.w&&t.h===n.h,mn=(t,n)=>{t.h=n.h,t.w=n.w};function wn(t,n){const e=t.getBBox();return{w:$(n?.w,48,e.width),h:$(n?.h,48,e.height)}}const yn=(n,e,o,i,a,s)=>{const c=t(n,e);c.width.baseVal.value=o,c.height.baseVal.value=i,c.x.baseVal.value=a,c.y.baseVal.value=s};function xn(t,n){let i;n.w??=96,n.h??=96;const a=function(t,n,e,o,i,a,s){const c=hn(n.id,e,o);return{el:c,cons:o,draw:un(t,c,n,o,null,null,sn,null,i,a,s).draw}}(t,n,'<rect data-key="outer" data-evt-no data-evt-index="2" width="144" height="144" x="-72" y="-72" fill="transparent" stroke="transparent" stroke-width="0" />\n\t\t <rect data-key="selected" width="96" height="96" x="-48" y="-48" rx="15" ry="15" fill="none" stroke="transparent" stroke-width="20" style="pointer-events: stroke;" />\n\t\t <rect data-key="main" width="96" height="96" x="-48" y="-48" rx="15" ry="15" stroke="transparent" stroke-width="10" style="pointer-events: none;" />',{right:{dir:"right",position:{x:48,y:0}},left:{dir:"left",position:{x:-48,y:0}},bottom:{dir:"bottom",position:{x:0,y:48}},top:{dir:"top",position:{x:0,y:-48}}},(()=>{const t=bn(n);return i=t.tCanvas,t.bInner}),(o=>s(function(t,n,o,i){const a=V(K(t[I].data,i),n,-1);o.w=a.x<48?48:a.x;const s=o.w/2;o.position.x=n.x+s,o.h=a.y<48?48:a.y;const c=o.h/2;return o.position.y=n.y+c,e(i.target,{x:s,y:c}),{x:-s,y:-c}}(t,i,n,o))),(t=>s(function(t,n){const e=t=>24*Math.round(t/24);t.w=e(t.w),t.h=e(t.h);const o=bn(t);return t.position.x=n.x-o.tInner.x,t.position.y=n.y-o.tInner.y,o.tInner}(n,i))));o(a.el,"shbox");const s=t=>{a.cons.right.position.x=n.w+t.x,a.cons.left.position.x=t.x,a.cons.bottom.position.y=n.h+t.y,a.cons.top.position.y=t.y,Ct(a),yn(a.el,"main",n.w,n.h,t.x,t.y),yn(a.el,"selected",n.w,n.h,t.x,t.y),yn(a.el,"outer",n.w+48,n.h+48,t.x-24,t.y-24),a.draw()};return 96!==n.w||96!==n.h?s(bn(n).tInner):a.draw(),a.el[at].patch=t=>{const e=Bt(a,t),o=(null!=t.w||null!=t.h)&&!gn(n,t);o&&mn(n,t),o?s(bn(n).tInner):e&&a.draw()},a.el}function bn(t){const n=t=>24*Math.floor(t/2/24),e=n(t.w),o=n(t.h);return{tCanvas:{x:t.position.x-e,y:t.position.y-o},tInner:{x:-e,y:-o},bInner:{x:t.w-e,y:t.h-o}}}const kn=(t,n)=>zt(n,new Mn(t,n));class Mn extends HTMLElement{constructor(t,n){super(),this.M=n,this.g=t}connectedCallback(){const t=this.attachShadow({mode:"closed"});t.innerHTML='<style>.ln{display:flex}.ln>*{height:24px;padding:10px;fill-opacity:.3;stroke-opacity:.3}[data-cmd]{cursor:pointer}.d-b [data-cmd-arg=d-b],.d-h [data-cmd-arg=d-h],.ta-1 [data-cmd-arg="1"],.ta-2 [data-cmd-arg="2"],.ta-3 [data-cmd-arg="3"]{fill-opacity:1;stroke-opacity:1}</style><ap-shape-edit id="edit" edit-btn="true"><div class="ln"><svg data-cmd="s" data-cmd-arg="d-h" viewBox="0 0 24 24" width="24" height="24"><path d="M17 11V4H19V21H17V13H7V21H5V4H7V11H17Z" fill="rgb(52,71,103)"></path></svg> <svg data-cmd="s" data-cmd-arg="d-b" viewBox="0 0 24 24" width="24" height="24"><path d="M8 11H12.5C13.8807 11 15 9.88071 15 8.5C15 7.11929 13.8807 6 12.5 6H8V11ZM18 15.5C18 17.9853 15.9853 20 13.5 20H6V4H12.5C14.9853 4 17 6.01472 17 8.5C17 9.70431 16.5269 10.7981 15.7564 11.6058C17.0979 12.3847 18 13.837 18 15.5ZM8 13V18H13.5C14.8807 18 16 16.8807 16 15.5C16 14.1193 14.8807 13 13.5 13H8Z" fill="rgb(52,71,103)"></path></svg></div><div class="ln"><svg data-cmd="a" data-cmd-arg="1" viewBox="0 0 24 24" width="24" height="24"><path fill="none" d="M0 0h24v24H0z"/><path d="M3 4h18v2H3V4zm0 15h14v2H3v-2zm0-5h18v2H3v-2zm0-5h14v2H3V9z" fill="rgb(52,71,103)"/></svg> <svg data-cmd="a" data-cmd-arg="2" viewBox="0 0 24 24" width="24" height="24"><path fill="none" d="M0 0h24v24H0z"/><path d="M3 4h18v2H3V4zm2 15h14v2H5v-2zm-2-5h18v2H3v-2zm2-5h14v2H5V9z" fill="rgb(52,71,103)"/></svg> <svg data-cmd="a" data-cmd-arg="3" viewBox="0 0 24 24" width="24" height="24"><path fill="none" d="M0 0h24v24H0z"/><path d="M3 4h18v2H3V4zm4 15h14v2H7v-2zm-4-5h18v2H3v-2zm4-5h14v2H7V9z" fill="rgb(52,71,103)"/></svg></div></ap-shape-edit>';const n=this.M[at].data,e=t.getElementById("edit");s(e,"cmd",(t=>{switch(t.detail.cmd){case"style":Et(this.g,this.M,t.detail.arg);break;case"del":$t(this.g,[this.M]);break;case"copy":Mt(this.g,[this.M])}}));const a=t=>Lt(this.g,this.M,t);o(e,`ta-${n.a}`),r(t,'[data-cmd="a"]',(t=>{const s=Number.parseInt(l(t,"data-cmd-arg"));s!==n.a&&(i(e,`ta-${n.a}`),o(e,`ta-${s}`),a({a:s}))})),["d-h","d-b"].forEach((t=>{n.styles?.includes(t)&&o(e,t)})),r(t,'[data-cmd="s"]',(t=>{const s=l(t,"data-cmd-arg"),c={styles:n.styles?A(n.styles):[]};c.styles?.includes(s)?(!function(t,n){const e=t.indexOf(n);e>-1&&t.splice(e,1)}(c.styles,s),i(e,s)):(c.styles??=[],c.styles.push(s),o(e,s)),a(c)}))}}function Hn(n,e){e.w??=48,e.h??=48,e.a??=1;const i=dn(n,e,`<rect data-key="outer" data-evt-no data-evt-index="2" width="96" height="96" x="-48" y="-48" fill="transparent" stroke="transparent" stroke-width="0" />\n\t\t <rect data-key="main" width="48" height="48" x="-24" y="-24" rx="15" ry="15" fill="#1aaee5" stroke="#fff" stroke-width="1" />\n\t\t <text data-key="text" data-evt-no y="${zn(e.h)}" x="${Cn(e)}" fill="#fff">&nbsp;</text>`,{right:{dir:"right",position:{x:24,y:0}},left:{dir:"left",position:{x:-24,y:0}},bottom:{dir:"bottom",position:{x:0,y:24}},top:{dir:"top",position:{x:0,y:-24}}},null,null,(t=>s(t)),kn,null);o(i.el,"shtxt"),o(i.el,`ta-${e.a}`);const a=()=>t(i.el,"text"),s=t=>{const n=$n(t);gn(e,n)||(mn(e,n),h())};let c,r,l;function d(){r=e.w,c=e.h,l=e.a}function h(t){if(function(t,n){const e=n.w/-2,o=n.h/-2;t.cons.left.position.y=o+24,t.cons.left.position.x=e,t.cons.top.position.y=o,t.cons.bottom.position.y=-o,t.cons.right.position.y=o+24,t.cons.right.position.x=-e,Ct(t),yn(t.el,"main",n.w,n.h,e,o),yn(t.el,"outer",n.w+48,n.h+48,e-24,o-24)}(i,e),t||l!==e.a||r!==e.w){const t=e.w/-2;let n,o;switch(e.a){case 1:n=t+8,o=(e.w-r)/2;break;case 2:n=0,o=0;break;case 3:n=-t-8,o=(e.w-r)/-2}const s=a();s.x.baseVal[0].value=n,s.querySelectorAll("tspan").forEach((t=>{t.x.baseVal[0].value=n})),e.position.x+=o,l!==e.a&&(Vn(i.el,l,e.a),l=e.a),r=e.w}c!==e.h&&(a().y.baseVal[0].value=zn(e.h),e.position.y+=(e.h-c)/2,c=e.h),i.draw()}return d(),48!==e.w||48!==e.h?h(!0):i.draw(),i.el[at].patch=t=>{const n=t.position&&!E(e.position,t.position);n&&B(e.position,t.position);let o=!1;t.styles&&(e.styles=t.styles,Tt(i.el),o=!0),null!=t.title&&e.title!==t.title&&(e.title=t.title,i.drawTxt(),o=!0);let s=!1;if(null==t.w&&o){const t=$n(a());gn(e,t)||(mn(e,t),s=!0)}null==t.w||gn(e,t)||(mn(e,t),d(),s=!0),null!=t.a&&e.a!==t.a&&(Vn(i.el,e.a,t.a),e.a=t.a,l=e.a,s=!0),s?(a().y.baseVal[0].value=zn(e.h),h(!0)):n&&i.draw()},i.el}function $n(t){const n=t.getBBox();return{w:$(0,48,n.width+12),h:$(0,48,n.height+14)}}customElements.define("ap-rect-txt-settings",Mn);const Cn=t=>1===t.a?-16:2===t.a?0:16,zn=t=>-t/2+24;function Vn(t,n,e){i(t,`ta-${n}`),o(t,`ta-${e}`)}function Ln(n,e,o){t(n,e).setAttribute("d",`M${o.l.x} ${o.l.y} L${o.t.x} ${o.t.y} L${o.r.x} ${o.r.y} L${o.b.x} ${o.b.y} Z`)}function Bn(t,n){const e=t/2,o=n-e,i=e-n;return{l:{x:o,y:0},t:{x:0,y:o},r:{x:i,y:0},b:{x:0,y:i}}}const Sn=(t,n)=>$(n,48,function(t){const n=f(t);return 2*(Math.abs(n.x)+Math.abs(n.y))}(t)-20);async function Tn(t,n,e){return function(t,n,e){let o,i;const a=En(t,n);if(a)o=new DataView(t,0,a.byteOffset-8),i=new DataView(t,a.byteOffset+a.byteLength+4);else{const n=t.byteLength-12;o=new DataView(t,0,n),i=new DataView(t,n)}const s=new DataView(new ArrayBuffer(8));return s.setUint32(0,e.length),s.setUint32(4,n),new Blob([o,s,e,new Uint32Array([0]),i],{type:"image/png"})}(await t.arrayBuffer(),Zn(n),e)}function En(t,n){const e=new DataView(t,8);let o,i=0,a=e.getUint32(4);for(;1229278788!==a;){if(o=e.getUint32(i),a===n)return new DataView(t,i+16,o);i=i+12+o,a=e.getUint32(i+4)}return null}function Zn(t){return new DataView((new TextEncoder).encode(t).buffer).getUint32(0)}function An(t,n,e,o){const i=t.ownerSVGElement.cloneNode(!0),s=i.querySelector("#canvas");let c;i.style.backgroundImage=null,e?(c=function(t){const n={x:1/0,y:1/0},e={x:-1/0,y:-1/0};for(const o of t){const t=o.getBoundingClientRect();n.x>t.x&&(n.x=t.x),n.y>t.y&&(n.y=t.y),e.x<t.right&&(e.x=t.right),e.y<t.bottom&&(e.y=t.bottom)}return{x:n.x,y:n.y,height:e.y-n.y,width:e.x-n.x}}(Rn(t,Dn)),C(s.children,(t=>((t,n)=>n.some((n=>a(t,n))))(t,Dn)?(Un(t),!0):(t.remove(),!1)))):(c=t.getBoundingClientRect(),Rn(s,Pn).forEach((t=>Un(t))));const r=i.getElementsByTagName("foreignObject");for(;r[0];)r[0].parentNode.removeChild(r[0]);const l=t[I].data,d=1/l.scale;s.style.transform=`matrix(1, 0, 0, 1, ${d*(l.position.x+15*l.scale-c.x)}, ${d*(l.position.y+15*l.scale-c.y)})`,function(t,n,e,o){const i=new Image;i.width=n.width*e*window.devicePixelRatio,i.height=n.height*e*window.devicePixelRatio,i.onload=function(){const t=document.createElement("canvas");t.width=i.width,t.height=i.height,t.style.width=`${i.width}px`,t.style.height=`${i.height}px`;const e=t.getContext("2d");e.imageSmoothingEnabled=!1,e.drawImage(i,n.x,n.y,n.width,n.height,0,0,i.width,i.height),URL.revokeObjectURL(i.src),t.toBlob(o,"image/png")},t.width.baseVal.newValueSpecifiedUnits(SVGLength.SVG_LENGTHTYPE_PX,i.width),t.height.baseVal.newValueSpecifiedUnits(SVGLength.SVG_LENGTHTYPE_PX,i.height),i.src=URL.createObjectURL(new Blob([(new XMLSerializer).serializeToString(t)],{type:"image/svg+xml;charset=utf-8"}))}(i,{x:0,y:0,height:c.height/l.scale+30,width:c.width/l.scale+30},3,(async t=>o(n?await Tn(t,"dgRm",(new TextEncoder).encode(n)):t)))}const Dn=["select","highlight"],Pn=["select","highlight","highlight-e","highlight-s"],Un=t=>{i(t,...Pn),t.querySelector(".resizer")?.remove()},Rn=(t,n)=>t.querySelectorAll(`.${n.join(", .")}`);async function On(t){const n=await async function(t,n){return En(await t.arrayBuffer(),Zn(n))}(t,"dgRm");return n?(new TextDecoder).decode(n):null}async function jn(t,n){const e=`web text/dgrm${D(lt(n,!0))}`;await async function(t){try{await navigator.clipboard.writeText(t)}catch(t){alert(t)}}(e),window.ClipboardItem&&An(t,null,!0,(async t=>{try{await navigator.clipboard.write([new window.ClipboardItem({[t.type]:Promise.resolve(t),"text/plain":Promise.resolve(new Blob([e],{type:"text/plain"}))})])}catch{}}))}const In=async()=>Fn(await async function(){try{return await navigator.clipboard.readText()}catch(t){return alert(t),null}}());function Fn(t){if(null==t||""===t.trim())return null;const n={txt:t};if(t.startsWith("web text/dgrm"))try{n.data=P(t.slice("web text/dgrm".length)),n.txt=null}catch{}return n}function Kn(t){return!!Gn(t)&&(t.c[t.i].u(),t.i-=1,!0)}function Nn(t){const n=Yn(t);return null!==n&&(t.i=n,t.c[n].r(),!0)}const Yn=t=>{if(!t)return null;const n=t.i+1;return n<=t.c.length-1?n:null},Gn=t=>t&&t.i>=0,Xn=(t,n,e)=>Qn(t,(()=>{qn(t,wt(n,e)),ut(t,e),St(n)}),(()=>{qn(t,mt(n,e)),ut(t,e)})),Jn=(t,n,e)=>Qn(t,(()=>{qn(t,mt(n,e)),ut(t,e)}),(()=>{qn(t,wt(n,e)),St(n)})),_n=(t,n,e)=>Qn(t,(()=>{qn(t,xt(e,n)),ut(t,n)}),(()=>{qn(t,xt(n,e)),ut(t,e)})),qn=(t,n)=>{n[Wn]=!0,M(t,n)},Wn=Symbol(0);function Qn(t,n,e){t[ae]??={c:[],i:-1},function(t,n,e){15===t.c.length&&(t.c.splice(0,1),t.i--),t.c.splice(t.i+1),t.i=t.c.push({u:n,r:e})-1}(t[ae],n,e),oe(t)}function te(t,n){n(t[ae])&&(t[I].select(null),oe(t))}const ne=t=>te(t,Kn),ee=t=>te(t,Nn);const oe=t=>{return M(t,k(ie,(n=t[ae],{u:Gn(n),r:null!==Yn(n)})));var n},ie="dgrmh",ae=Symbol("h");function se(t,n,e,o){if(!n?.data&&!n?.txt)return void W("Clipboard is empty");t[I].select(Ht(t,function(t){if(!t)return null;const n=new Map,e=t=>{const e=Z();return n.set(t,e),e},o=[];for(const n in t.s){const i=e(t.s[n].id);t.s[i]=t.s[n],t.s[i].id=i,delete t.s[n],0===t.s[i].type&&o.push(t.s[i])}return o.forEach((t=>{t.s.s=n.get(t.s.s),t.e.s=n.get(t.e.s)})),t}(n.data)??(()=>{const e=function(t,n){const e=u("text");on(e,null,n),e.style.visibility="hidden",t.append(e);const o=$n(e);return e.remove(),o}(t,n.txt);return dt({id:Z(),type:3,position:{x:0,y:0},title:n.txt,w:e.w,h:e.h})})(),!0,e,o))}class ce extends HTMLElement{connectedCallback(){const t=this.attachShadow({mode:"closed"});t.innerHTML='<style>.menu{overflow-x:auto;padding:0;position:fixed;top:50%;left:5px;transform:translateY(-50%);box-shadow:0 4px 24px rgba(0,0,0,.12);border-radius:8px;background-color:rgba(255,255,255,.9)}.content{white-space:nowrap;display:flex;flex-direction:column}[data-cmd]{cursor:move}.menu svg{padding:10px}.stroke{stroke:#344767;stroke-width:2px;fill:transparent}.menu .big{width:62px;min-width:62px}@media only screen and (max-width:700px){.menu{width:100%;border-radius:0;bottom:0;display:flex;flex-direction:column;top:unset;left:unset;transform:unset}.content{align-self:center;flex-direction:row}}</style><div id="menu" class="menu" style="touch-action:none"><div class="content"><svg class="stroke" data-cmd="shapeAdd" data-cmd-arg="1" viewBox="0 0 24 24" width="24" height="24"><circle r="9" cx="12" cy="12"></circle></svg> <svg class="stroke" data-cmd="shapeAdd" data-cmd-arg="4" viewBox="0 0 24 24" width="24" height="24"><path d="M2 12 L12 2 L22 12 L12 22 Z" stroke-linejoin="round"></path></svg> <svg class="stroke" data-cmd="shapeAdd" data-cmd-arg="2" viewBox="0 0 24 24" width="24" height="24"><rect x="2" y="4" width="20" height="16" rx="3" ry="3"></rect></svg> <svg data-cmd="shapeAdd" data-cmd-arg="0" viewBox="0 0 24 24" width="24" height="24"><path fill="none" d="M0 0h24v24H0z"/><path d="M13 8v8a3 3 0 0 1-3 3H7.83a3.001 3.001 0 1 1 0-2H10a1 1 0 0 0 1-1V8a3 3 0 0 1 3-3h3V2l5 4-5 4V7h-3a1 1 0 0 0-1 1z" fill="rgb(52,71,103)"/></svg> <svg data-cmd="shapeAdd" data-cmd-arg="3" viewBox="0 0 24 24" width="24" height="24"><path fill="none" d="M0 0h24v24H0z"/><path d="M13 6v15h-2V6H5V4h14v2z" fill="rgb(52,71,103)"/></svg> <svg data-cmd="shapeAdd" data-cmd-arg="5" viewBox="0 0 24 24" width="24" height="24"><path d="M7.82929 20C7.41746 21.1652 6.30622 22 5 22C3.34315 22 2 20.6569 2 19C2 17.6938 2.83481 16.5825 4 16.1707V7.82929C2.83481 7.41746 2 6.30622 2 5C2 3.34315 3.34315 2 5 2C6.30622 2 7.41746 2.83481 7.82929 4H16.1707C16.5825 2.83481 17.6938 2 19 2C20.6569 2 22 3.34315 22 5C22 6.30622 21.1652 7.41746 20 7.82929V16.1707C21.1652 16.5825 22 17.6938 22 19C22 20.6569 20.6569 22 19 22C17.6938 22 16.5825 21.1652 16.1707 20H7.82929ZM7.82929 18H16.1707C16.472 17.1476 17.1476 16.472 18 16.1707V7.82929C17.1476 7.52801 16.472 6.85241 16.1707 6H7.82929C7.52801 6.85241 6.85241 7.52801 6 7.82929V16.1707C6.85241 16.472 7.52801 17.1476 7.82929 18ZM5 6C5.55228 6 6 5.55228 6 5C6 4.44772 5.55228 4 5 4C4.44772 4 4 4.44772 4 5C4 5.55228 4.44772 6 5 6ZM19 6C19.5523 6 20 5.55228 20 5C20 4.44772 19.5523 4 19 4C18.4477 4 18 4.44772 18 5C18 5.55228 18.4477 6 19 6ZM19 20C19.5523 20 20 19.5523 20 19C20 18.4477 19.5523 18 19 18C18.4477 18 18 18.4477 18 19C18 19.5523 18.4477 20 19 20ZM5 20C5.55228 20 6 19.5523 6 19C6 18.4477 5.55228 18 5 18C4.44772 18 4 18.4477 4 19C4 19.5523 4.44772 20 5 20Z" fill="rgba(52,71,103,1)"></path></svg></div></div>';const n=t.getElementById("menu");n.querySelectorAll('[data-cmd="shapeAdd"]').forEach((t=>{s(t,"pointerdown",this),s(t,"click",this)})),s(n,"pointerleave",this),s(n,"pointerup",this),s(n,"pointermove",this)}init(t){this.g=t}handleEvent(t){switch(t.type){case"pointermove":if(!this.H){const n=document.elementFromPoint(t.clientX,t.clientY);if(n===this.$)return;this.C===this.$&&this.g.ownerSVGElement.setPointerCapture(t.pointerId),this.$=n}break;case"pointerleave":if(this.H=!0,null!=this.V){const n=re(this.g,this.V,!1,t.clientX,t.clientY)[0];h(t)||this.g[I].select([n]),n[at]?n[at]?.moveCapture(t,n,!0):n[it]?.moveCapture(t,n,!0)}this.L();break;case"pointerdown":this.V=parseInt(l(t,"data-cmd-arg")),this.C=document.elementFromPoint(t.clientX,t.clientY),this.$=this.C,this.H=null;break;case"pointerup":this.L();break;case"click":this.g.ownerSVGElement.focus(),this.g[I].select(re(this.g,parseInt(l(t,"data-cmd-arg")),!0))}}L(){this.V=null,this.C=null,this.$=null}}customElements.define("ap-menu-shape",ce);const re=(t,n,e,o,i)=>Ht(t,dt(0===n?{id:Z(),type:0,s:{data:{dir:"right",position:{x:-24,y:0}}},e:{data:{dir:"right",position:{x:24,y:0}}}}:{id:Z(),type:n,position:{x:0,y:0},title:"Title"}),e,o,i);class le extends HTMLElement{constructor(t){super(),this.g=t}connectedCallback(){const t=this.attachShadow({mode:"closed"});t.innerHTML='<style>.menu{position:fixed;top:5px;left:60px;white-space:nowrap;display:flex;flex-direction:row}svg{padding:10px;fill:#344767;opacity:.4}.actv{opacity:1;cursor:pointer}</style><div class="menu"><svg id="u" width="24" height="24" viewBox="0 0 24 24"><path d="m6.907 6.68 2.734-2.73a6.66 6.66 0 1 1 9.42 9.42l-8.338 8.338a1 1 0 0 1-1.415-1.415l8.339-8.336A4.66 4.66 0 0 0 11.229 5.2l-.174.166-3.641 3.633H12a1 1 0 0 1 .993.884L13 10a1 1 0 0 1-.883.993l-.117.006-7.06-.001-.095-.01-.112-.024-.131-.047-.082-.04-.102-.064a.996.996 0 0 1-.125-.107l-.092-.105-.074-.114-.046-.093-.038-.105-.016-.058-.016-.081-.007-.062L4 10V3.002a1 1 0 0 1 1.993-.116L6 3.002v4.584l3.641-3.635L6.907 6.68Z"></path></svg> <svg id="r" width="24" height="24" fill="none" viewBox="0 0 24 24"><path d="M18 7.586 14.36 3.951a6.66 6.66 0 1 0-9.42 9.42l8.339 8.337a1 1 0 0 0 1.414-1.415l-8.339-8.336A4.66 4.66 0 0 1 12.771 5.2l.174.166 3.64 3.633H12a1 1 0 0 0-.993.884L11 10a1 1 0 0 0 .883.993l.117.006h7a1 1 0 0 0 .993-.883L20 10V3.002a1 1 0 0 0-1.993-.116L18 3.002v4.584L14.36 3.951 18 7.586Z"/></svg></div>';const n=t.getElementById("u"),e=t.getElementById("r");s(this.g,ie,(t=>{const a=(t,n)=>n?o(t,"actv"):i(t,"actv");a(n,t.detail.u),a(e,t.detail.r)})),s(n,"click",(t=>ne(this.g))),s(e,"click",(t=>ee(this.g)))}}function de(t,n){ht(t,n),function(t){const n=t.getBoundingClientRect(),e=window.innerWidth/2,o=window.innerHeight/2;t[I].move(e-n.width/2-n.x,o-n.height/2-n.y,1);const i=t=>t>1?1:Math.max(t,.25),a=Math.min(i(window.innerWidth/n.width),i(window.innerHeight/n.height));a<1&&t[I].scale(a,{x:e,y:o})}(t)}function he(t,n){const e=function(t,n){async function e(e){if(document.activeElement===t.ownerSVGElement){const o=n();if(o?.length)return e.preventDefault(),jn(t,o),o}return null}async function o(n){const o=await e(n);o&&$t(t,o)}return document.addEventListener("copy",e),document.addEventListener("cut",o),function(){c(document,"copy",e),c(document,"cut",o)}}(t,n);function o(e){if(!d(e)&&("Delete"===e.key||"Backspace"===e.key)){const e=n();e?.length&&$t(t,e)}}return s(document,"keydown",o),function(){e(),c(document,"keydown",o)}}function ue(t,n){return ve?async function(t){try{const n=await window.showSaveFilePicker(ge),e=await n.createWritable();return await e.write(t),await e.close(),n}catch{alert("File not saved")}}(t):function(t,n){const e=document.createElement("a");e.download=n,e.href=URL.createObjectURL(t),e.click(),URL.revokeObjectURL(e.href),e.remove()}(t,n)}function pe(){return fe?async function(){const[t]=await window.showOpenFilePicker(ge);return{h:t,f:await t.getFile()}}():new Promise(((t,n)=>{!function(t,n){const e=document.createElement("input");e.type="file",e.multiple=!1,e.accept=".png",s(e,"cancel",(t=>n(t)),!0),s(e,"change",(async()=>t(e.files?.length?e.files[0]:null)),!0),e.click(),e.remove()}((n=>{t({f:n})}),(t=>n(t)))}))}customElements.define("ap-history",le);const fe="showOpenFilePicker"in window,ve="showSaveFilePicker"in window,ge={types:[{description:"PNG Image",accept:{"image/png":[".png"]}}]};class me extends HTMLElement{constructor(t,n){super(),this.g=t,this.B=n}connectedCallback(){const t=this.attachShadow({mode:"closed"});t.innerHTML=`<style>.ln{display:flex;align-items:center;color:#0d6efd;line-height:25px;padding:5px 10px;cursor:pointer;white-space:nowrap}.ln>*{margin-right:10px}</style><div id="clone" class="ln" style="padding-top:10px">${Dt}Create copy</div><div id="copy" class="ln"><svg viewBox="0 0 24 24" width="24" height="24"><path fill="none" d="M0 0h24v24H0z"/><path d="M7 6V3a1 1 0 0 1 1-1h12a1 1 0 0 1 1 1v14a1 1 0 0 1-1 1h-3v3c0 .552-.45 1-1.007 1H4.007A1.001 1.001 0 0 1 3 21l.003-14c0-.552.45-1 1.007-1H7zm2 0h8v10h2V4H9v2z" fill="rgb(52,71,103)"/></svg>Copy to clipboard</div><div id="save" class="ln">${Pt}Save image</div><div id="del" class="ln" style="padding-bottom:10px">${At}Delete</div>`;const n=this.parentElement;function e(e,o){s(t.getElementById(e),"click",(t=>{n.remove(),o()}))}e("clone",(()=>Mt(this.g,this.B()))),e("copy",(async()=>await jn(this.g,this.B()))),e("save",(()=>An(this.g,D(lt(this.B(),!1)),!0,(async t=>ue(t,"dgrm.png"))))),e("del",(()=>$t(this.g,this.B())))}}customElements.define("ap-grp-settings",me);const we=Symbol("p");const ye=(t,n,e)=>{if(e[we])return;const o=nt(e),i=Pe(o);if(!i)return void Ve(n);const a=Te(n,o),s=Ae(n);if(s&&a)Ue(i,e);else{if(e.shiftKey){if(s){const t=Ze(n);Re(t),$e(n,t)}return a?Ce(n,i):$e(n,i),void Be(n,e)}a?q(new me(t,(()=>Le(n))),e.clientX-10,e.clientY-10):(Ve(n),$e(n,i),Be(n,e))}},xe=(t,n,e,o)=>{if(e[we])return;if(o===t.ownerSVGElement)return void t[I].moveCapture();const i=Te(n,o);if(!i&&!h(e))return void t[I].moveCapture();if(!i&&h(e))return Ve(n),void Oe(Pe(o),e,o);const a=Ae(n);i&&a?Oe(Pe(o),e,o):i&&!a&&be(t,n,e)},be=(t,n,e)=>{const o=()=>ke(n),i=t=>Me(n,t),a=o();x(t.ownerSVGElement,e,(n=>i((e=>R(e,t[I].data.scale,n)))),(n=>{i((n=>N(n,t[I].data.cell))),yt(t,a,o())}))},ke=t=>lt([...t.shapesToMove,...je(t.pathEndsToMove)],!1,!0),Me=(t,n)=>{t.shapesToMove?.forEach((t=>{n(t[at].data.position),t[at].drawPosition()})),t.pathEndsToMove?.forEach((t=>{n(t.data.position),Ie(t)[it].drawPosition()}))},He=()=>({shapes:new Set,paths:new Set,pathEnds:new Set,shapesToMove:new Set,pathEndsToMove:new Set}),$e=(t,n)=>{if(n.shape)t.shapes.add(n.shape),o(n.shape,"highlight");else if(n.path)t.paths.add(n.path),o(n.path,"highlight"),i(n.path,"highlight-s","highlight-e"),t.pathEnds.delete(n.path[it].data.s),t.pathEnds.delete(n.path[it].data.e);else if(n.pathEnd){const e=Ie(n.pathEnd);if(t.paths.has(e))return;t.pathEnds.add(n.pathEnd),o(e,Ne(n.pathEnd))}},Ce=(t,n)=>{if(n.shape)t.shapes.delete(n.shape),i(n.shape,"highlight");else if(n.path)t.paths.delete(n.path),t.pathEnds.delete(n.path[it].data.s),t.pathEnds.delete(n.path[it].data.e),i(n.path,"highlight","highlight-s","highlight-e");else if(n.pathEnd){const e=Ie(n.pathEnd);if(t.paths.delete(e)){i(e,"highlight","highlight-s","highlight-e");const a=Ke(n.pathEnd);t.pathEnds.add(a),o(e,Ne(a))}else t.pathEnds.delete(n.pathEnd),i(e,Ne(n.pathEnd))}},ze=t=>{const n=t=>i(t,"highlight","highlight-s","highlight-e");t.shapes.forEach((t=>n(t))),t.paths.forEach((t=>n(t))),t.pathEnds.forEach((t=>n(Ie(t))))},Ve=t=>{ze(t);const n=Ze(t);n&&Re(n),t.pathEnds.clear(),t.pathEndsToMove.clear(),t.paths.clear(),t.shapes.clear(),t.shapesToMove.clear()},Le=t=>[...t.shapes,...t.paths,...je(t.pathEnds)],Be=(t,n)=>{Se(t);const e=Ee(t);e&&(ze(t),Ue(e,n))},Se=t=>{t.shapesToMove=new Set(t.shapes),t.pathEndsToMove=new Set;const n=n=>{n.shape?t.shapesToMove.add(n.shape.shapeEl):t.pathEndsToMove.add(n)};t.paths?.forEach((t=>{n(t[it].data.s),n(t[it].data.e)})),t.pathEnds?.forEach(n)},Te=(t,n)=>[...t.shapes,...[...t.pathEnds].map((t=>t.el)),...t.paths].some((t=>t.contains(n))),Ee=t=>De(t)?Ze(t):{},Ze=t=>1!==t.shapes.size||t.paths.size||t.pathEnds.size?t.shapes.size||1!==t.paths.size||t.pathEnds.size?t.shapes.size||t.paths.size||1!==t.pathEnds.size?null:{pathEnd:z(t.pathEnds)}:{path:z(t.paths)}:{shape:z(t.shapes)},Ae=t=>!!Ze(t),De=t=>t.shapes.size||t.pathEnds.size||t.paths.size,Pe=t=>{const n=t[at]?{shape:t}:t.parentElement[at]?{shape:t.parentElement}:t.parentElement.parentElement[at]?{shape:t.parentElement.parentElement}:null;if(n)return n;const e=t[it]?{path:t}:t.parentElement[it]?{path:t.parentElement}:null;if(e)return e;const o=Fe(t);return o?{pathEnd:o}:null},Ue=(t,n)=>{t.shape?t.shape[at].click(n):t.path?t.path[it].click(n):t.pathEnd&&Ie(t.pathEnd)[it].click(n,t.pathEnd.el)},Re=t=>{t.shape?t.shape[at].unselect():t.path?t.path[it].unselect():t.pathEnd&&Ie(t.pathEnd)[it].unselect()},Oe=(t,n,e)=>{t.shape?t.shape[at].moveCapture(n,e):t.path?t.path[it].moveCapture(n,e):t.pathEnd&&Ie(t.pathEnd)[it].moveCapture(n,e)},je=t=>[...t].map(Ie),Ie=t=>t.el.parentNode,Fe=t=>{const n=t.hasAttribute("data-key")?t:t.parentElement.hasAttribute("data-key")?t.parentElement:null;if(!n)return null;const e=n.parentNode[it].data;return e.s.el===n?e.s:e.e},Ke=t=>{const n=Ie(t)[it].data;return n.s===t?n.e:n.s},Ne=t=>Ie(t)[it].data.s===t?"highlight-s":"highlight-e";const Ye=(t,n,e,o,i)=>t.x<=o&&o<=t.x+n&&t.y<=i&&i<=t.y+e;const Ge={iceServers:[{urls:"stun:stun3.l.google.com:19302"}]},Xe="https://dgrm.boyko.tech/api/m/",Je=()=>{const t=`User${Math.floor(100*Math.random())}`,n=prompt("Your name",t);return null==n?null:n?.substring(0,25)??t},_e=t=>document.getElementById("menu").bage(t),qe=t=>{const n=We(t),e=document.createElement("div");return e.innerHTML=`<svg viewBox="0 0 24 24" width="24" height="24"><path d="M2.89945 2.30007L21.7052 8.56867C21.9672 8.65599 22.1088 8.93915 22.0215 9.20112C21.975 9.34065 21.8694 9.45262 21.7328 9.50725L13.0002 13.0003L8.57501 21.8506C8.45151 22.0976 8.15118 22.1977 7.90419 22.0742C7.77883 22.0115 7.68553 21.8991 7.64703 21.7644L2.26058 2.91177C2.18472 2.64626 2.33846 2.36951 2.60398 2.29365C2.70087 2.26597 2.80386 2.26821 2.89945 2.30007Z" fill="${n}"></path></svg> <span style="background-color:rgba(255,255,255,.5);border-radius:5px;padding:2px">${t}</span>`,e.style.cssText=`position: fixed; top:0; color:${n}; pointer-events: none;`,e.style.transform="translate(-9999px, 0px)",document.body.append(e),e},We=t=>`hsl(${[...t].reduce(((t,n)=>n.charCodeAt(0)+((t<<5)-t)),0)%360}, 95%, 35%)`,Qe=(t,n,e,o)=>{const i=((t,n,e)=>({x:t.position.x+n*t.scale,y:t.position.y+e*t.scale}))(t[I].data,e,o);n.style.transform=`translate(${i.x}px, ${i.y}px)`},to=(t,n,e)=>{const o=t=>e(D(t)),i=s(t,"dgrmc",(t=>o([4,t.detail.shapesToCreateData]))),a=s(t,"dgrmu",(t=>o([4,t.detail.shapesToUpdData]))),r=s(t,"dgrmd",(t=>o([5,t.detail.delIds])));let l=!0;const d=s(t.ownerSVGElement,"pointermove",H((e=>{if(l){const i=F(t[I].data,e.clientX,e.clientY);o([6,n,i.x,i.y])}}),60));return()=>{l=!1,c(t,"dgrmc",i),c(t,"dgrmu",a),c(t,"dgrmd",r),c(t.ownerSVGElement,"pointermove",d)}};async function no(t,n,e,o){const i=Je();if(null==i)return e(),null;_(!0);const a=Z(),s=new Map,c=await async function(t,n,e,o,i){const a=await async function(t,n,e){const o=new RTCPeerConnection(Ge),i=o.createDataChannel("dgrm");return i.onopen=n=>t(i,n),i.onmessage=t=>n(i,t),i.onerror=t=>{o.close(),e()},await o.setLocalDescription(),new Promise(((t,n)=>{o.onicecandidate=n=>{n.candidate||t(o)}}))}(e,o,i);await((t,n,e)=>g(`${Xe}o`,{m:t,c:n,s:e}))(n,t,a.localDescription.sdp);const s=U(3e3,15e3,(async()=>{try{const e=await(async(t,n)=>(await fetch(`${Xe}a?m=${t}&c=${n}`)).text())(n,t);e&&(s(),a.setRemoteDescription({sdp:e,type:"answer"}))}catch{c(),i()}}),i),c=()=>{s(),a.close(),_(!1)};return c}(a,n,((t,n)=>t.send(D([0,a,i]))),((n,e)=>{const o=P(e.data);switch(o[0]){case 6:Qe(t,s.get(o[1]),o[2],o[3]);break;case 4:ut(t,o[1]);break;case 5:St(o[1]);break;case 0:s.set(o[1],qe(o[2]));break;case 7:s.get(o[1]).remove(),s.delete(o[1]);break;case 2:de(t,o[1]),l(n);break;case 3:t[I].move(o[1],o[2],1),l(n)}}),(()=>{d(),o()}));let r;const l=n=>{r=to(t,a,(t=>n.send(t))),_(!1)},d=()=>{s.forEach((t=>t.remove())),r&&r(),c(),_(!1)};return d}async function eo(t,n,e){const o=Je();if(null==o)return n(),null;const i=Z(),a=Z(),s=new Map,c=(t,n)=>s.forEach(((e,o)=>o!==n?o.send(t):null)),r=await async function(t,n,e,o,i){const a=Z();await((t,n)=>g(`${Xe}c`,{m:t,k:n}))(t,a);const s=new Set,c=U(5e3,72e5,(async()=>{try{const i=await(async(t,n)=>{const e=await(await fetch(`${Xe}o?m=${t}&k=${n}`)).json();return e?Object.entries(e):void 0})(t,a);if(!i?.length)return;i.forEach((async i=>{const c=await async function(t,n,e,o){const i=new RTCPeerConnection(Ge);return i.ondatachannel=t=>{const a=t.channel;a.onopen=t=>n(a,t),a.onmessage=t=>e(a,t),a.onerror=t=>{i.close(),o(i,a,t)}},await i.setRemoteDescription({sdp:t,type:"offer"}),await i.setLocalDescription(),new Promise(((t,n)=>{i.onicecandidate=n=>{n.candidate||t(i)}}))}(i[1],((t,e)=>n(i[0],t,e)),e,((t,n,e)=>{s.delete(t),o(n,e)}));s.add(c),await((t,n,e,o)=>g(`${Xe}a`,{m:t,k:n,c:e,s:o}))(t,a,i[0],c.localDescription.sdp)}))}catch{r(),i()}})),r=()=>{c(),s?.forEach((t=>t.close()))};return r}(i,((n,e,i)=>{e.send(D([0,a,o]));const c=rt(t);e.send(D(ct(c)?[3,t[I].data.position.x,t[I].data.position.y]:[2,c])),s.forEach((t=>e.send(D([0,t.i,t.n]))))}),((n,e)=>{const o=P(e.data);switch(o[0]){case 6:Qe(t,s.get(n).c,o[2],o[3]),c(e.data,n);break;case 4:ut(t,o[1]),c(e.data,n);break;case 5:St(o[1]),c(e.data,n);break;case 0:s.set(n,{i:o[1],n:o[2],c:qe(o[2])}),c(e.data,n)}}),((t,n)=>{const e=s.get(t);c(D([7,e.i]),t),e.c.remove(),s.delete(t)}),(()=>{d(),e()})),l=to(t,a,c),d=()=>{l(),s.forEach((t=>t.c.remove())),r()};return{dispose:d,id:i}}function oo(t,n,e){const o=document.createElement("div");o.style.cssText="padding: 15px; min-width:220px;",o.innerHTML=`<style>button{cursor:pointer;color:#495057;font-size:16px;padding:10px;border-radius:8px;border:none;background-color:#f2f2f2}.btn-main{color:#0d6efd}.btn-del{color:#e74c3c}.w100{width:100%}</style><div style="margin-bottom:20px"><a ap-close>Close</a></div><div style="margin-bottom:20px">live collaboration in progress</div><div style="margin-bottom:10px"><button mshare class="w100 btn-main">Share invitation link</button></div><div><button mstop class="w100 btn-del" style="color:#e74c3c">${e?"Disconnect":"Stop collaboration"}</button></div>`;const i=q(o),a=(t,n)=>s(o.querySelector(`[${t}]`),"click",(t=>{i.del(),n()}));a("mstop",n),a("mshare",(async n=>{await navigator.clipboard.writeText(m("m",t)),W("Link copied to clipboard")}))}const io=t=>{t[so]?.dispose(),t[so]=void 0,_e(!1)},ao=t=>{io(t),alert("Live collaboration disabled")},so=Symbol(0);class co extends HTMLElement{connectedCallback(){this.S=this.attachShadow({mode:"closed"}),this.S.innerHTML=`<style>.menu{position:fixed;top:5px;left:5px;cursor:pointer;padding:10px}#options{position:fixed;padding:10px 15px 15px 15px;box-shadow:0 4px 24px rgba(0,0,0,.12);border-radius:8px;background-color:#fff;top:0;left:0;z-index:1}#options a,#options div{color:#0d6efd;cursor:pointer;padding:5px 0;display:flex;align-items:center;line-height:25px}#options a svg,#options div svg{margin-right:10px}#a{margin-left:auto;font-size:smaller}@media only screen and (min-width:700px){#a{display:none!important}}hr{color:transparent;border-top:1px solid rgba(52,71,103,.2)}.bage::after{position:absolute;right:2px;top:5px;min-width:4px;min-height:4px;padding:4px;background-color:#e74c3c;border-radius:8px;content:'';border:solid 1px #e74c3c}#options .bage{position:relative}</style><div id="menu" class="menu"><svg viewBox="0 0 24 24" width="24" height="24"><path fill="none" d="M0 0h24v24H0z"/><path d="M3 4h18v2H3V4zm0 7h18v2H3v-2zm0 7h18v2H3v-2z" fill="rgb(52,71,103)"/></svg></div><div id="options" style="visibility:hidden"><div id="menu2"><svg viewBox="0 0 24 24" width="24" height="24"><path fill="none" d="M0 0h24v24H0z"/><path d="M3 4h18v2H3V4zm0 7h18v2H3v-2zm0 7h18v2H3v-2z" fill="rgb(52,71,103)"/></svg><a id="a" href="https://dgrm.net" target="_blank">About</a></div><div id="new"><svg viewBox="0 0 24 24" width="24" height="24"><path fill="none" d="M0 0h24v24H0z"/><path d="M9 2.003V2h10.998C20.55 2 21 2.455 21 2.992v18.016a.993.993 0 0 1-.993.992H3.993A1 1 0 0 1 3 20.993V8l6-5.997zM5.83 8H9V4.83L5.83 8zM11 4v5a1 1 0 0 1-1 1H5v10h14V4h-8z" fill="rgb(52,71,103)"/></svg>New</div><div id="open"><svg viewBox="0 0 24 24" width="24" height="24"><path fill="none" d="M0 0h24v24H0z"/><path d="M3 21a1 1 0 0 1-1-1V4a1 1 0 0 1 1-1h7.414l2 2H20a1 1 0 0 1 1 1v3h-2V7h-7.414l-2-2H4v11.998L5.5 11h17l-2.31 9.243a1 1 0 0 1-.97.757H3zm16.938-8H7.062l-1.5 6h12.876l1.5-6z" fill="rgb(52,71,103)"/></svg>Open</div>${fe?'<div id="save"><svg viewBox="0 0 24 24" width="24" height="24"><path d="M7 19V13H17V19H19V7.82843L16.1716 5H5V19H7ZM4 3H17L21 7V20C21 20.5523 20.5523 21 20 21H4C3.44772 21 3 20.5523 3 20V4C3 3.44772 3.44772 3 4 3ZM9 15V19H15V15H9Z" fill="rgba(52,71,103,1)"></path></svg>Save</div>':""}<div id="saveas">${Pt}Save${ve?" as":""}</div><hr/><div id="link"><svg viewBox="0 0 24 24" width="24" height="24"><path fill="none" d="M0 0h24v24H0z"/><path d="M13.06 8.11l1.415 1.415a7 7 0 0 1 0 9.9l-.354.353a7 7 0 0 1-9.9-9.9l1.415 1.415a5 5 0 1 0 7.071 7.071l.354-.354a5 5 0 0 0 0-7.07l-1.415-1.415 1.415-1.414zm6.718 6.011l-1.414-1.414a5 5 0 1 0-7.071-7.071l-.354.354a5 5 0 0 0 0 7.07l1.415 1.415-1.415 1.414-1.414-1.414a7 7 0 0 1 0-9.9l.354-.353a7 7 0 0 1 9.9 9.9z" fill="rgb(52,71,103)"/></svg>Share link to diagram</div><div id="collab"><svg viewBox="0 0 24 24" width="24" height="24"><path d="M2 22C2 17.5817 5.58172 14 10 14C14.4183 14 18 17.5817 18 22H16C16 18.6863 13.3137 16 10 16C6.68629 16 4 18.6863 4 22H2ZM10 13C6.685 13 4 10.315 4 7C4 3.685 6.685 1 10 1C13.315 1 16 3.685 16 7C16 10.315 13.315 13 10 13ZM10 11C12.21 11 14 9.21 14 7C14 4.79 12.21 3 10 3C7.79 3 6 4.79 6 7C6 9.21 7.79 11 10 11ZM18.2837 14.7028C21.0644 15.9561 23 18.752 23 22H21C21 19.564 19.5483 17.4671 17.4628 16.5271L18.2837 14.7028ZM17.5962 3.41321C19.5944 4.23703 21 6.20361 21 8.5C21 11.3702 18.8042 13.7252 16 13.9776V11.9646C17.6967 11.7222 19 10.264 19 8.5C19 7.11935 18.2016 5.92603 17.041 5.35635L17.5962 3.41321Z" fill="rgba(52,71,103,1)"></path></svg>Live collaboration</div></div>`;const t=this.S.getElementById("options");function n(){t.style.visibility="visible"===t.style.visibility?"hidden":"visible"}const e=this;function o(t,o){e.S.getElementById(t).onclick=async t=>{n(),_(!0),await o(t),_(!1)}}this.S.getElementById("menu").onclick=e=>{n(),s(document,"pointerdown",(n=>{this.contains(n.target)||(t.style.visibility="hidden")}),!0)},this.S.getElementById("menu2").onclick=n,o("new",(()=>{lo(this.g)})),fe&&o("save",(async()=>await ho(this.g))),o("saveas",(()=>uo(this.g))),o("open",(async()=>{try{const t=await pe();await ro(this.g,t.f),this.g[go]=t.h}catch(t){console.log(t),fo()}})),o("link",(async t=>{const n=rt(this.g);if(ct(n))return void vo();const e=function(){const t=new Date;return`${t.getUTCFullYear()}${(t.getUTCMonth()+1).toString().padStart(2,"0")}${Z()}`}(),o=m("k",e);!h(t)&&navigator.canShare&&navigator.canShare({url:o})?(await tt(e,n),await navigator.share({url:o})):(await navigator.clipboard.writeText(o.toString()),await tt(e,n),W("Link copied to clipboard"))})),o("collab",(async t=>await async function(t){const n=()=>io(t),e=()=>ao(t);try{switch(t[so]?.clientType){case 1:oo(t[so].id,n);break;case 2:oo(t[so].id,n,!0);break;default:{const o=await eo(t,n,e);if(!o)return;s(t,"dgrmn",e,!0),t[so]={clientType:1,id:o.id,dispose:()=>{c(t,"dgrmn",e),o.dispose()}},_e(!0),oo(t[so].id,n);break}}}catch{e()}}(this.g)))}init(t){var n,e;this.g=t,document.body.addEventListener("dragover",(t=>{t.preventDefault()})),document.body.addEventListener("drop",(async t=>{if(t.preventDefault(),1===t.dataTransfer?.items?.length&&"file"===t.dataTransfer.items[0].kind&&"image/png"===t.dataTransfer.items[0].type)if("getAsFileSystemHandle"in t.dataTransfer.items[0]){const n=await t.dataTransfer.items[0].getAsFileSystemHandle();await ro(this.g,await n.getFile()),this.g[go]=n}else await ro(this.g,t.dataTransfer.items[0].getAsFile());else fo()})),n=async()=>await ho(this.g),e=()=>uo(this.g),document.addEventListener("keydown",(t=>{!t.ctrlKey&&!t.metaKey||t.repeat||"KeyS"!==t.code||(t.preventDefault(),t.shiftKey?e():n())}))}bage(t){const n=t?o:i;n(this.S.getElementById("menu"),"bage"),n(this.S.getElementById("collab"),"bage")}}async function ro(t,n){const e=await On(n);e?(lo(t),de(t,P(e))):fo()}function lo(t){M(t,k("dgrmn")),function(t){for(t[I].select(null);t.firstChild;)(t.firstChild[at]||t.firstChild[it]).del();t[I].move(0,0,1)}(t),function(t){var n;(n=t[ae])&&(n.c=[],n.i=-1),oe(t)}(t),t[go]=void 0}customElements.define("ap-menu",co);const ho=async t=>{t[go]?po(t,(async n=>{const e=await t[go].createWritable();await e.write(n),await e.close()})):uo(t)},uo=t=>po(t,(async n=>{const e=ue(n,"dgrm.png");t[go]=e?await e:void 0}));function po(t,n){const e=rt(t);ct(e)?vo():An(t,D(e),null,n)}const fo=()=>alert("File cannot be read. Use the exact image file you got from the application."),vo=()=>alert("Diagram is empty"),go=Symbol(0),mo=document.getElementById("canvas");if(mo[I]={data:{position:{x:0,y:0},scale:1,cell:24},shapeMap:function(n){const i=t=>(n.append(t),t);return{0:{create:t=>i(Yt(n,t))},1:{create:o=>i(function(n,o){o.r??=48;let i,a=o.r;const s=dn(n,o,'<circle data-key="outer" data-evt-no data-evt-index="2" r="72" fill="transparent" stroke-width="0"/><circle data-key="main" r="48" fill="#ff6600" stroke="#fff" stroke-width="1"/><text data-key="text" x="0" y="0" text-anchor="middle" style="pointer-events:none" fill="#fff"></text>',{right:{dir:"right",position:{x:48,y:0}},left:{dir:"left",position:{x:-48,y:0}},bottom:{dir:"bottom",position:{x:0,y:48}},top:{dir:"top",position:{x:0,y:-48}}},(()=>(i=L(o.position,-o.r),{x:o.r,y:o.r})),(r=>{let l=K(n[I].data,r).x-i.x;l<48&&(l=48);const d=48*Math.round(l/48)/2;o.r!==d&&fn(t(s.el,"text"))<=d&&(o.r=d,o.position.x=i.x+d,o.position.y=i.y+d,c(),a=d);const h=l-o.r;e(r.target,{x:h,y:h})}),(t=>{const n=fn(t,a);n!==o.r&&(o.r=n,c())}));function c(){s.cons.right.position.x=o.r,s.cons.left.position.x=-o.r,s.cons.bottom.position.y=o.r,s.cons.top.position.y=-o.r,Ct(s),pn(s.el,"outer",o.r+24),pn(s.el,"main",o.r),s.draw()}return 48!==o.r?c():s.draw(),s.el[at].patch=t=>{const n=Bt(s,t),e=null!=t.r&&o.r!==t.r;e&&(o.r=t.r),e?c():n&&s.draw()},s.el}(n,o))},2:{create:t=>i(vn(n,t))},3:{create:t=>i(Hn(n,t))},4:{create:a=>i(function(n,i){i.w??=96;let a,s=i.w;const c=dn(n,i,'<path data-key="outer" data-evt-no data-evt-index="2" d="M-72 0 L0 -72 L72 0 L0 72 Z" stroke-width="0" fill="transparent"/><path data-key="border" d="M-39 0 L0 -39 L39 0 L0 39 Z" stroke-width="20" stroke="#fff" fill="transparent" stroke-linejoin="round"/><path data-key="main" d="M-39 0 L0 -39 L39 0 L0 39 Z" stroke-width="18" stroke-linejoin="round" stroke="#1D809F" fill="#1D809F"/><text data-key="text" x="0" y="0" text-anchor="middle" style="pointer-events:none" fill="#fff"></text>',{right:{dir:"right",position:{x:48,y:0}},left:{dir:"left",position:{x:-48,y:0}},bottom:{dir:"bottom",position:{x:0,y:48}},top:{dir:"top",position:{x:0,y:-48}}},(()=>{const t=i.w/2;return a=L(i.position,-t),{x:t,y:t}}),(o=>{let l=K(n[I].data,o).x-a.x;l<48&&(l=48);const d=48*Math.round(l/48);if(i.w!==d&&Sn(t(c.el,"text"))<=d){i.w=d;const t=d/2;i.position.x=a.x+t,i.position.y=a.y+t,r(),s=d}const h=l-i.w/2;e(o.target,{x:h,y:h})}),(t=>{const n=Sn(t,s);n!==i.w&&(i.w=n,r())}));function r(){const t=Bn(i.w,0);c.cons.right.position.x=t.r.x,c.cons.left.position.x=t.l.x,c.cons.bottom.position.y=t.b.y,c.cons.top.position.y=t.t.y,Ct(c);const n=Bn(i.w,9);Ln(c.el,"main",n),Ln(c.el,"border",n),Ln(c.el,"outer",Bn(i.w,-24)),c.draw()}return o(c.el,"shrhomb"),96!==i.w?r():c.draw(),c.el[at].patch=t=>{const n=Bt(c,t),e=null!=t.w&&i.w!==t.w;e&&(i.w=t.w),e?r():n&&c.draw()},c.el}(n,a))},5:{create:t=>{return e=xn(n,t),n.prepend(e),e;var e}}}}(mo)},mo.ownerSVGElement.addEventListener("contextmenu",(async t=>{d(t)||t.preventDefault()})),function(t){let n,e,o;function i(t){t.isPrimary&&t.isTrusted&&(n&&Math.abs(n.x-t.clientX)<3&&Math.abs(n.y-t.clientY)<3?t.stopImmediatePropagation():(n=null,void 0===t.movementX?(t[O]=e?t.clientX-e:0,t[j]=o?t.clientY-o:0,e=t.clientX,o=t.clientY):(t[O]=t.movementX,t[j]=t.movementY)))}t.addEventListener("pointerdown",(a=>{n={x:a.clientX,y:a.clientY},e=null,o=null,t.addEventListener("pointermove",i,{capture:!0,passive:!0}),t.addEventListener("pointerup",(n=>{c(t,"pointermove",i,!0)}),{capture:!0,once:!0,passive:!0})}),{capture:!0,passive:!0})}(document),function(t){s(document,"paste",(async n=>{d(n)||se(t,Fn(n.clipboardData.getData("text/plain")))})),s(document,"keydown",(n=>{!n.ctrlKey&&!n.metaKey||n.repeat||d(n)||("KeyZ"===n.code?ne(t):"KeyY"===n.code&&ee(t))}))}(mo),function(t){const n=t.ownerSVGElement;let i,a,r,l,d;const h=()=>{d?.remove(),d=null};let p=!1;function f(t){if(t[we]||!r)return void g();t[we]=!0,p&&(h(),p=!1);const n=t.clientX-a.x,e=t.clientY-a.y;r.width.baseVal.value=Math.abs(n),r.height.baseVal.value=Math.abs(e),n<0&&(l.x=t.clientX),e<0&&(l.y=t.clientY),r.style.transform=`translate(${l.x}px, ${l.y}px)`}function v(n){if(r&&!p){n[we]=!0;const e=n=>Ye(F(t[I].data,l.x,l.y),r.width.baseVal.value/t[I].data.scale,r.height.baseVal.value/t[I].data.scale,n.x,n.y);!function(t,n,e,o){const i=He(),a=t=>$e(i,t),s=t=>t.shape&&e(t.shape.shapeEl)||o(t);for(const t of n)if(t[at])e(t)&&a({shape:t});else if(t[it]){const n=s(t[it].data.s),e=s(t[it].data.e);n&&e?a({path:t}):n?a({pathEnd:t[it].data.s}):e&&a({pathEnd:t[it].data.e})}t[I].selectedSet(i)}(t,t.children,(t=>e(t[at].data.position)),(t=>e(t.data.position)))}g()}function g(){clearTimeout(i),i=null,r?.remove(),r=null,h(),p=!1,c(n,"pointermove",f),c(n,"wheel",g),c(n,"pointercancel",g),c(n,"pointerup",v)}s(n,"pointerdown",(c=>{if(!c.isPrimary||nt(c)!==n)return void g();s(n,"pointermove",f),s(n,"wheel",g,!0),s(n,"pointercancel",g,!0),s(n,"pointerup",v,!0);const h=()=>{t[I].selectedSet(null),p=!0,n.setPointerCapture(c.pointerId),a={x:c.clientX,y:c.clientY},l={x:c.clientX,y:c.clientY},r=u("rect"),r.style.cssText="rx:8px; fill: rgb(108 187 247 / 51%)",e(r,l),n.append(r)};2!==c.button?i=setTimeout((t=>{h(),d=u("circle"),o(d,"ative-elem"),d.style.cssText="r:10px; fill: rgb(108 187 247 / 51%)",e(d,{x:c.clientX,y:c.clientY}),n.append(d)}),500):h()}))}(mo),function(t){const n=t.ownerSVGElement;let e,o,i=He();s(n,"pointerdown",(a=>{if(!a.isPrimary)return c(n,"pointermove",e),c(n,"pointerup",o),void t[I].moveCapture();o=o=>{c(n,"pointermove",e),ye(t,i,o)},s(n,"pointerup",o,!0),e=e=>{c(n,"pointerup",o),xe(t,i,e,nt(a))},0===a.button&&s(n,"pointermove",e,!0)})),he(t,(()=>Le(i)));const a=t=>{Ve(i),i=t??He(),Be(i,null)};t[I].selectedSet=a,t[I].select=t=>{const n=He();t?.forEach((t=>$e(n,Pe(t)))),a(n)}}(mo),function(t){const n=t[I].data,e=function(t,n){let e;function o(n){e!==n&&(e=n,t.style.backgroundImage=`radial-gradient(rgb(73 80 87 / ${n}) 1px, transparent 0)`)}return o(.6),t.style.backgroundSize=`${n.cell}px ${n.cell}px`,function(){const e=n.cell*n.scale;n.scale<.5?o(0):n.scale<=.9?o(.2):o(.6),t.style.backgroundSize=`${e}px ${e}px`,t.style.backgroundPosition=`${n.position.x}px ${n.position.y}px`}}(t.ownerSVGElement,n);function o(){t.style.transform=`matrix(${n.scale}, 0, 0, ${n.scale}, ${n.position.x}, ${n.position.y})`,e()}function i(t,e){if(t<.25||t>4)return;const i=t/n.scale;n.scale=t,n.position.x=i*(n.position.x-e.x)+e.x,n.position.y=i*(n.position.y-e.y)+e.y,o()}!function(t,n,e,o){let i,a,r,l,d=!1;function h(t){r=null,l=null,i?.id===t.pointerId&&(i=null),a?.id===t.pointerId&&(a=null),i||a||(c(document,"pointermove",u),c(document,"pointercancel",h),c(document,"pointerup",h),d=!1)}function u(t){if(d){if(i&&!a||!i&&a)return n.position.x=t.clientX+(i||a).shift.x,n.position.y=t.clientY+(i||a).shift.y,void o();if(!a||!i||a?.id!==t.pointerId&&i?.id!==t.pointerId)return;const s=Math.hypot(i.pos.x-a.pos.x,i.pos.y-a.pos.y),c={x:(i.pos.x+a.pos.x)/2,y:(i.pos.y+a.pos.y)/2};r&&(n.position.x=n.position.x+c.x-l.x,n.position.y=n.position.y+c.y-l.y,e(n.scale/r*s,c)),r=s,l=c}i?.id===t.pointerId&&(i=G(t,n)),a?.id===t.pointerId&&(a=G(t,n))}s(t.ownerSVGElement,"pointerdown",(t=>{!i&&!t.isPrimary||i&&a||(i||(s(document,"pointermove",u),s(document,"pointercancel",h),s(document,"pointerup",h),i=G(t,n)),a||i?.id===t.pointerId||(a=G(t,n)))})),t[I].moveCapture=()=>{d=!0}}(t,n,i,o),t.ownerSVGElement.addEventListener("wheel",(t=>{t.preventDefault();const e=t.deltaY||t.deltaX,o=Math.abs(e)<50?.05:.25;i(n.scale+(e<0?o:-o),Y(t))})),t[I].move=function(t,e,i){n.position.x=t,n.position.y=e,n.scale=i,o()},t[I].scale=i}(mo),function(t){if(!navigator.clipboard.readText)return void t.ownerSVGElement.addEventListener("contextmenu",(async n=>{t.ownerSVGElement===nt(n)&&n.preventDefault()}));const n=t.ownerSVGElement,e=t.ownerDocument;let o,i,a,r;function l(n){c(e,"pointermove",u),c(e,"pointerup",d),a||(a=function(t,n,e,o){const i=document.createElement("div");i.innerHTML='<style>.ln{display:flex;align-items:center;color:#0d6efd;line-height:25px;padding:10px;cursor:pointer;white-space:nowrap}.ln>*{margin-right:10px}</style><div class="ln"><svg viewBox="0 0 24 24" width="24" height="24"><path fill="none" d="M0 0h24v24H0z"/><path d="M7 4V2h10v2h3.007c.548 0 .993.445.993.993v16.014a.994.994 0 0 1-.993.993H3.993A.994.994 0 0 1 3 21.007V4.993C3 4.445 3.445 4 3.993 4H7zm0 2H5v14h14V6h-2v2H7V6zm2-2v2h6V4H9z" fill="rgb(52,71,103)"/></svg>Paste</div>',s(i,"click",(async i=>{se(e,await In(),t,n),o()}));return{del:q(i,t-10,n-10).del,el:i}}(n.clientX,n.clientY,t,d),s(e,"pointerdown",h))}function d(){clearTimeout(o),o=null,a?.del(),a=null,c(e,"pointerdown",h),c(e,"pointerup",d),c(e,"wheel",d),c(e,"keydown",d),c(e,"pointerup",f),c(e,"pointercancel",f),c(e,"pointermove",p),i=!1,r=!1}function h(t){a.el.contains(t.target)||d()}function u(){d(),i=!0}function p(){r||d(),i=!0}function f(){r=!0}s(n,"pointerdown",(async function(t){t.isPrimary&&nt(t)===n?(d(),s(e,"pointermove",u,!0),s(e,"pointerup",d,!0),s(e,"wheel",d,!0),s(e,"keydown",d,!0),2!==t.button&&(o=setTimeout((n=>{l(t),s(e,"pointerup",f,!0),s(e,"pointercancel",f,!0),s(e,"pointermove",p,!0)}),500))):d()})),n.addEventListener("contextmenu",(async t=>{n===nt(t)&&(t.preventDefault(),i||l(t))}))}(mo),(t=>{const n=(n,e)=>s(t,n,(t=>{t[Wn]||e(t)}));n("dgrmc",(n=>Xn(t,n.detail.newIds,n.detail.shapesToCreateData))),n("dgrmd",(n=>Jn(t,n.detail.delIds,n.detail.shapesToDelData))),n("dgrmu",(n=>_n(t,n.detail.shapesBeforeUpdData,n.detail.shapesToUpdData)))})(mo),document.getElementById("menu").init(mo),document.getElementById("menu-shape").init(mo),document.body.append(new le(mo)),y("k")){_(!0);const t=await(async t=>(await fetch(`${Q}/${t}`)).json())(y("k"));w("k"),de(mo,t),_(!1)}else if(y("m")){const t=y("m");w("m"),await async function(t,n){const e=()=>ao(t);try{const o=await no(t,n,(()=>io(t)),e);if(!o)return;s(t,"dgrmn",e,!0),t[so]={clientType:2,id:n,dispose:()=>{c(t,"dgrmn",e),o()}},_e(!0)}catch{e()}}(mo,t)}else!function(t){const n=document.getElementById("tip");function e(){n.style.display="none",c(document,"pointerdown",o),c(document,"wheel",e),c(document,"keydown",e),c(document,"dragover",e)}function o(t){n.contains(t.target)||e()}t?(n.style.display="unset",s(document,"pointerdown",o),s(document,"wheel",e,!0),s(document,"keydown",e,!0),s(document,"dragover",e,!0),s(document.getElementById("tipclose"),"click",e,!0)):e()}(!0);
