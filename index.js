!function(){"use strict";function t(t,e){if(!t)return null;let n;for(const s of t)e&&!e(s)||(n=s);return n}function e(t,e){if(!t)return!1;for(const n of t)if(!e||e(n))return!0;return!1}function n(t,e){const n=t.stateGet();n.has(e)||t.update({state:n.add(e)})}function s(t,e){const n=t.stateGet();var s,i;n.has(e)&&t.update({state:(s=n,i=e,s.delete(i),s)})}function i(t){const e=t.shape.postionGet(),n=t.innerPosition;return{templateKey:"connect-end",position:{x:e.x+n.x,y:e.y+n.y},postionIsIntoCanvas:!0,rotate:"out"===t.connectorType?"right"===t.dir?0:"left"===t.dir?180:"bottom"===t.dir?90:270:"right"===t.dir?180:"left"===t.dir?0:"bottom"===t.dir?270:90}}class o{constructor(t){this.t=t}add(t,e){const s=this.t.append("path",{templateKey:"path",start:{position:o.o(t),dir:t.dir},end:{position:o.o(e),dir:e.dir?e.dir:o.h(t.dir)}});s.start=t,s.end=e,n(e,"connected"),o.u(t.shape,s),o.u(e.shape,s)}replaceEnd(i,r){const c=t(i.shape.connectedPaths,(t=>t.end===i));c.update({end:{position:o.o(r),dir:r.dir?r.dir:i.dir}}),c.end=r,i.shape!==r.shape&&(c.start.shape!==i.shape&&i.shape.connectedPaths.delete(c),o.u(r.shape,c)),e(i.shape.connectedPaths,(t=>t.start===i||t.end===i))||s(i,"connected"),n(r,"connected")}updatePosition(t){if(!e(t.connectedPaths))return;const n=t.postionGet();for(const e of t.connectedPaths)e.update({start:e.start.shape===t?{position:{x:n.x+e.start.innerPosition.x,y:n.y+e.start.innerPosition.y}}:null,end:e.end.shape===t?{position:{x:n.x+e.end.innerPosition.x,y:n.y+e.end.innerPosition.y}}:null})}deleteByShape(t){if(e(t.connectedPaths))for(const e of t.connectedPaths)e.end.shape.connectedPaths.delete(e),s(e.end,"connected"),e.start.shape.connectedPaths.delete(e),s(e.start,"connected"),e.end.shape.connectable&&this.t.delete(e.end.shape),this.t.delete(e)}startConnectorGet(e){return t(e.shape.connectedPaths,(t=>t.end===e)).start}static u(t,e){t.connectedPaths||(t.connectedPaths=new Set),t.connectedPaths.add(e)}static o(t){const e=t.shape.postionGet();return{x:e.x+t.innerPosition.x,y:e.y+t.innerPosition.y}}static h(t){switch(t){case"bottom":return"top";case"top":return"bottom";case"left":return"right";case"right":return"left"}}}class r extends EventTarget{constructor(t,e){super(),this.t=t.on("pointermove",this).on("pointerdown",this).on("pointerup",this).on("pointerenter",this).on("pointerleave",this),this.l=e}on(t,e){return this.addEventListener(t,e),this}shapeAdd(t){return this.t.append("shape",t)}shapeDel(t){this.l.deleteByShape(t),this.t.delete(t)}shapeConnect(t){this.l.add(t.start.shape.connectors.get(t.start.connector),t.end.shape.connectors.get(t.end.connector))}handleEvent(t){switch(t.type){case"pointermove":if(this.p){const e={x:this.v.x+t.detail.offsetX,y:this.v.y+t.detail.offsetY};this.p.update({position:e}),this.l.updatePosition(this.p)}break;case"pointerdown":switch(t.detail.target.type){case"canvas":case"shape":this.m(t.detail.target,{x:t.detail.offsetX,y:t.detail.offsetY});break;case"connector":this.g(t)}break;case"pointerup":"connector"===t.detail.target.type&&this.C(t),this.k(),this._();break;case"pointerenter":this.p&&this.p.connectable&&("connector"===t.detail.target.type||"shape"===t.detail.target.type)&&this.S(t.detail.target);break;case"pointerleave":this._()}}g(t){switch(t.detail.target.connectorType){case"out":{const e=this.shapeAdd(i(t.detail.target));this.m(e,{x:t.detail.offsetX,y:t.detail.offsetY}),this.l.add(t.detail.target,e.defaultInConnector);break}case"in":if(t.detail.target.stateGet().has("connected")){if(!this.$("disconnect",{start:this.l.startConnectorGet(t.detail.target),end:t.detail.target}))return;const e=this.shapeAdd(i(t.detail.target));this.m(e,{x:t.detail.offsetX,y:t.detail.offsetY}),this.l.replaceEnd(t.detail.target,e.defaultInConnector)}}}C(t){this.p&&this.p.connectable&&"in"===t.detail.target.connectorType&&this.$("connect",{start:this.l.startConnectorGet(this.p.defaultInConnector),end:t.detail.target})&&(this.l.replaceEnd(this.p.defaultInConnector,t.detail.target),this.shapeDel(this.p))}P(t){t!==this.T&&(this.$("select",{target:t}),this.T&&s(this.T,"selected"),t&&n(t,"selected"),this.T=t)}m(t,e){this.p=t,this.p.connectable&&n(this.p,"disabled");const s=this.p.postionGet();this.v={x:s.x-e.x,y:s.y-e.y},this.P(this.p)}k(){this.p&&s(this.p,"disabled"),this.v=null,this.p=null}S(t){this.O=t,n(t,"hovered"),"connector"===t.type&&n(t.shape,"hovered")}_(){this.O&&(s(this.O,"hovered"),"connector"===this.O.type&&s(this.O.shape,"hovered"),this.O=null)}$(t,e){return this.dispatchEvent(new CustomEvent(t,{cancelable:!0,detail:e}))}}class c{constructor({svgEl:t,start:e,end:n}){this.svgEl=t,this.G=e,this.j=n,this.type="path",this.I()}update(t){t.start&&Object.assign(this.G,t.start),t.end&&Object.assign(this.j,t.end),this.I()}I(){this.svgEl.setAttribute("d",c.M(70,this.G,this.j))}static M(t,e,n){return`M ${e.position.x} ${e.position.y} C ${c.K(e.dir,e.position.x,t)} ${c.R(e.dir,e.position.y,t)}, ${c.K(n.dir,n.position.x,t)} ${c.R(n.dir,n.position.y,t)}, ${n.position.x} ${n.position.y}`}static K(t,e,n){return"right"===t||"left"===t?"right"===t?e+n:e-n:e}static R(t,e,n){return"right"===t||"left"===t?e:"bottom"===t?e+n:e-n}}function h(t,e,n){let s=function(t,e){for(const n of t)if(!e||e(n))return n;return null}(t.transform.baseVal,(t=>t.type===e));return s||(s=(t.ownerSVGElement||n).createSVGTransform(),t.transform.baseVal.appendItem(s)),s}function a(t){const e=h(t,SVGTransform.SVG_TRANSFORM_TRANSLATE).matrix;return{x:e.e,y:e.f}}class d{constructor({svgEl:t,connectorType:e,shape:n,key:s,innerPosition:i,dir:o}){this.U=t,this.A=new Set,this.type="connector",this.connectorType=e,this.shape=n,this.key=s,this.innerPosition=i,this.dir=o}stateGet(){return this.A}update(t){this.A=t.state,this.A.has("connected")?this.U.classList.add("connected"):this.U.classList.remove("connected"),this.A.has("hovered")?this.U.classList.add("hover"):this.U.classList.remove("hover")}}class u{constructor({svgEl:t,type:e=null,connectable:n=null,defaultInConnector:s=null}){this.A=new Set,this.svgEl=t,this.type=e||"shape",this.connectable=n,this.defaultInConnector=s,this.connectors=new Map}stateGet(){return this.A}postionGet(){return a(this.svgEl)}update(t){var e,n,s;t.position&&(e=this.svgEl,n=t.position,h(e,SVGTransform.SVG_TRANSFORM_TRANSLATE,s).setTranslate(n.x,n.y)),t.rotate&&function(t,e,n){h(t,SVGTransform.SVG_TRANSFORM_ROTATE,n).setRotate(e,0,0)}(this.svgEl,t.rotate),t.props&&u.D(this.svgEl,t.props),t.state&&(this.A=t.state,this.A.has("selected")?this.svgEl.classList.add("selected"):this.svgEl.classList.remove("selected"),this.A.has("hovered")?this.svgEl.classList.add("hover"):this.svgEl.classList.remove("hover"),this.A.has("disabled")?this.svgEl.style.pointerEvents="none":this.svgEl.style.pointerEvents="auto")}static D(t,e){Object.keys(e).forEach((n=>{const s="root"===n?t:t.querySelector(`[data-key='${n}'`);Object.keys(e[n]).forEach((t=>{if("textContent"===t)s.innerHTML=e[n][t]?e[n][t].toString().replaceAll("\n",'<tspan x="0" dy="1.2em">&ZeroWidthSpace;</tspan>'):"";else s.setAttribute(t,e[n][t].toString())}))}))}}function l(t,e){return new d({svgEl:t,connectorType:"in"===t.getAttribute("data-connect")?"in":"out",shape:e,key:t.getAttribute("data-key"),innerPosition:p(t),dir:t.getAttribute("data-connect-dir")})}function p(t){if(!t.getAttribute("data-connect-point"))return null;const e=t.getAttribute("data-connect-point").split(",");return{x:parseFloat(e[0]),y:parseFloat(e[1])}}class f extends EventTarget{constructor(t){super(),this.L=t,this.L.addEventListener("pointermove",this),this.L.addEventListener("pointerdown",this),this.L.addEventListener("pointerup",this),this.N=new WeakMap,this.V=t.querySelector('[data-key="canvas"]'),this.N.set(this.V,new u({svgEl:this.V,type:"canvas"}))}append(t,e){switch(t){case"shape":return function({svgCanvas:t,listener:e,svgElemToPresenterObj:n,createParams:s}){const i=t.ownerSVGElement.getElementsByTagName("defs")[0].querySelector(`[data-templ='${s.templateKey}']`).cloneNode(!0);t.append(i);const o=new u({svgEl:i});if(!s.postionIsIntoCanvas){const e=a(t);s.position.x-=e.x,s.position.y-=e.y}return o.update(s),o.connectable="true"===i.getAttribute("data-connectable"),p(i)&&(o.defaultInConnector=l(i,o)),i.addEventListener("pointerdown",e),i.querySelectorAll("[data-connect]").forEach((t=>{const s=l(t,o);t.addEventListener("pointerdown",e),n.set(t,s),o.connectors.set(s.key,s)})),n.set(i,o),o}({svgCanvas:this.V,svgElemToPresenterObj:this.N,listener:this,createParams:e});case"path":return function({svgCanvas:t,createParams:e}){const n=t.ownerSVGElement.getElementsByTagName("defs")[0].querySelector(`[data-templ='${e.templateKey}']`).cloneNode(!0);return t.append(n),new c({svgEl:n,start:e.start,end:e.end})}({svgCanvas:this.V,createParams:e})}}delete(t){this.N.delete(t.svgEl),t.svgEl.remove()}on(t,e){return this.addEventListener(t,e),this}handleEvent(t){switch(t.stopPropagation(),t.type){case"pointermove":this.F(t),this.$("pointermove",null,t.offsetX,t.offsetY);break;case"pointerdown":this.$(t.type,t.currentTarget,t.offsetX,t.offsetY);break;case"pointerup":this.$(t.type,document.elementFromPoint(t.clientX,t.clientY),t.offsetX,t.offsetY)}}F(t){const e=document.elementFromPoint(t.clientX,t.clientY);e!==this.J&&(this.J&&this.$("pointerleave",this.J,t.offsetX,t.offsetY),e&&this.$("pointerenter",e,t.offsetX,t.offsetY),this.J=e)}$(t,e,n,s){let i=null;e&&(i=this.N.get(e===this.L||e.ownerSVGElement!==this.L?this.V:e),i||(i=this.N.get(e.closest("[data-connect]"))),i||(i=this.N.get(e.closest("[data-templ]")))),this.dispatchEvent(new CustomEvent(t,{detail:{target:i,offsetX:n,offsetY:s}}))}}function v(t,e){return e&&"text"!==t?e.replaceAll("\n"," "):e}const m=document.getElementById("panel"),w=document.getElementById("text");w.addEventListener("input",k),w.addEventListener("change",k),document.getElementById("del").addEventListener("click",(function(){if(!y)return;g.delete(y),b=b.filter((t=>t.start.shape!==y&&t.end.shape!==y)),x.shapeDel(y),E(null)})),document.getElementById("gear").addEventListener("click",(function(){m.classList.contains("open")?m.classList.remove("open"):m.classList.add("open")})),document.getElementById("menu").querySelectorAll("[data-shape]").forEach((t=>t.addEventListener("click",(t=>{t.preventDefault(),C({templateKey:t.currentTarget.getAttribute("data-shape"),position:{x:120,y:120},detail:"Title"})})))),document.getElementById("save").addEventListener("click",(function(){const t=function(t,e){if(!t||0===t.size)return null;const n={s:[]},s=new Map;for(const e of t)e[1].position=e[0].postionGet(),s.set(e[0],n.s.push(e[1])-1);return e&&e.length>0&&(n.c=e.map((t=>({s:{i:s.get(t.start.shape),c:t.start.key},e:{i:s.get(t.end.shape),c:t.end.key}})))),JSON.stringify(n)}(g,b);if(t){const e=new URL(window.location.href);return e.hash=encodeURIComponent(t),void navigator.clipboard.writeText(`${e.toString()}`).then((t=>alert("Link to diagram copied to clipboard")))}alert("Nothing to save")}));const g=new Map;let y,b=[];const x=function(t){const e=new f(t);return new r(e,new o(e))}(document.getElementById("diagram")).on("select",(t=>E(t.detail.target))).on("connect",(t=>{b.push(t.detail)})).on("disconnect",(t=>{b.splice(b.findIndex((e=>{return n=e,s=t.detail,n.start.shape===s.start.shape&&n.start.key===s.start.key&&n.end.shape===s.end.shape&&n.end.key===s.end.key;var n,s})),1)}));function C(t){t.props={text:{textContent:v(t.templateKey,t.detail)}};const e=x.shapeAdd(t);return g.set(e,{templateKey:t.templateKey,detail:t.detail}),e}function k(){y&&(g.get(y).detail=w.value,y.update({props:{text:{textContent:v(g.get(y).templateKey,w.value)}}}))}function E(t){t&&"shape"===t.type?(y=t,m.classList.add("selected"),g.has(t)?(w.value=g.get(t).detail,w.disabled=!1):(w.value=null,w.disabled=!0)):(y=null,m.classList.remove("selected"))}if(window.location.hash){const t=JSON.parse(decodeURIComponent(window.location.hash.substring(1)));if(t.s&&t.s.length>0){const e=[];for(const n of t.s)e.push(C(n));if(t.c&&t.c.length>0)for(const n of t.c)x.shapeConnect({start:{shape:e[n.s.i],connector:n.s.c},end:{shape:e[n.e.i],connector:n.e.c}})}history.replaceState(null,null," ")}}();
