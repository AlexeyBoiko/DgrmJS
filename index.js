!function(){"use strict";function t(t,e){if(!t)return!1;for(const s of t)if(!e||e(s))return!0;return!1}function e(t,e){const s=t.stateGet();s.has(e)||t.update({state:s.add(e)})}function s(t,e){const s=t.stateGet();var n,i;s.has(e)&&t.update({state:(n=s,i=e,n.delete(i),n)})}function n(t){const e=t.shape.postionGet(),s=t.innerPosition;return{templateKey:"connect-end",position:{x:e.x+s.x,y:e.y+s.y},postionIsIntoCanvas:!0,rotate:"out"===t.connectorType?"right"===t.dir?0:"left"===t.dir?180:"bottom"===t.dir?90:270:"right"===t.dir?180:"left"===t.dir?0:"bottom"===t.dir?270:90}}class i{constructor(t){this.t=t}add(t,s){const n=this.t.append("path",{templateKey:"path",start:{position:i.i(t),dir:t.dir},end:{position:i.i(s),dir:s.dir?s.dir:i.o(t.dir)}});n.start=t,n.end=s,e(s,"connected"),i.h(t.shape,n),i.h(s.shape,n)}replaceEnd(n,o){const r=function(t,e){if(!t)return null;let s;for(const n of t)e&&!e(n)||(s=n);return s}(n.shape.connectedPaths,(t=>t.end===n));r.update({end:{position:i.i(o),dir:o.dir?o.dir:n.dir}}),r.end=o,n.shape!==o.shape&&(r.start.shape!==n.shape&&n.shape.connectedPaths.delete(r),i.h(o.shape,r)),t(n.shape.connectedPaths,(t=>t.start===n||t.end===n))||s(n,"connected"),e(o,"connected")}updatePosition(e){if(!t(e.connectedPaths))return;const s=e.postionGet();for(const t of e.connectedPaths)t.update({start:t.start.shape===e?{position:{x:s.x+t.start.innerPosition.x,y:s.y+t.start.innerPosition.y}}:null,end:t.end.shape===e?{position:{x:s.x+t.end.innerPosition.x,y:s.y+t.end.innerPosition.y}}:null})}deleteByShape(e){if(t(e.connectedPaths))for(const t of e.connectedPaths)t.end.shape.connectedPaths.delete(t),s(t.end,"connected"),t.start.shape.connectedPaths.delete(t),s(t.start,"connected"),t.end.shape.connectable&&this.t.delete(t.end.shape),this.t.delete(t)}static h(t,e){t.connectedPaths||(t.connectedPaths=new Set),t.connectedPaths.add(e)}static i(t){const e=t.shape.postionGet();return{x:e.x+t.innerPosition.x,y:e.y+t.innerPosition.y}}static o(t){switch(t){case"bottom":return"top";case"top":return"bottom";case"left":return"right";case"right":return"left"}}}class o extends EventTarget{constructor(t,e){super(),this.t=t.on("pointermove",this).on("pointerdown",this).on("pointerup",this).on("pointerenter",this).on("pointerleave",this),this.l=e}on(t,e){return this.addEventListener(t,e),this}shapeAdd(t){return this.t.append("shape",t)}shapeDel(t){this.l.deleteByShape(t),this.t.delete(t)}shapeConnect(t){this.l.add(t.start.shape.connectors.get(t.start.connector),t.end.shape.connectors.get(t.end.connector))}handleEvent(t){switch(t.type){case"pointermove":if(this.u){const e={x:this.p.x+t.detail.offsetX,y:this.p.y+t.detail.offsetY};this.u.update({position:e}),this.l.updatePosition(this.u)}break;case"pointerdown":switch(t.detail.target.type){case"canvas":case"shape":this.v(t.detail.target,{x:t.detail.offsetX,y:t.detail.offsetY});break;case"connector":this.m(t)}break;case"pointerup":"connector"===t.detail.target.type&&this.g(t),this.k(),this._();break;case"pointerenter":this.u&&this.u.connectable&&("connector"===t.detail.target.type||"shape"===t.detail.target.type)&&this.C(t.detail.target);break;case"pointerleave":this._()}}m(t){switch(t.detail.target.connectorType){case"out":{const e=this.shapeAdd(n(t.detail.target));this.v(e,{x:t.detail.offsetX,y:t.detail.offsetY}),this.l.add(t.detail.target,e.defaultInConnector);break}case"in":if(t.detail.target.stateGet().has("connected")){const e=this.shapeAdd(n(t.detail.target));this.v(e,{x:t.detail.offsetX,y:t.detail.offsetY}),this.l.replaceEnd(t.detail.target,e.defaultInConnector)}}}g(t){this.u&&this.u.connectable&&"in"===t.detail.target.connectorType&&(this.l.replaceEnd(this.u.defaultInConnector,t.detail.target),this.shapeDel(this.u))}S(t){t!==this.T&&(this.$("select",t),this.T&&s(this.T,"selected"),t&&e(t,"selected"),this.T=t)}v(t,s){this.u=t,this.u.connectable&&e(this.u,"disabled");const n=this.u.postionGet();this.p={x:n.x-s.x,y:n.y-s.y},this.S(this.u)}k(){this.u&&s(this.u,"disabled"),this.p=null,this.u=null}C(t){this.P=t,e(t,"hovered"),"connector"===t.type&&e(t.shape,"hovered")}_(){this.P&&(s(this.P,"hovered"),"connector"===this.P.type&&s(this.P.shape,"hovered"),this.P=null)}$(t,e){return this.dispatchEvent(new CustomEvent(t,{cancelable:!0,detail:{target:e}}))}}class r{constructor({svgEl:t,start:e,end:s}){this.svgEl=t,this.j=e,this.G=s,this.type="path",this.O()}update(t){t.start&&Object.assign(this.j,t.start),t.end&&Object.assign(this.G,t.end),this.O()}O(){this.svgEl.setAttribute("d",r.M(70,this.j,this.G))}static M(t,e,s){return`M ${e.position.x} ${e.position.y} C ${r.A(e.dir,e.position.x,t)} ${r.D(e.dir,e.position.y,t)}, ${r.A(s.dir,s.position.x,t)} ${r.D(s.dir,s.position.y,t)}, ${s.position.x} ${s.position.y}`}static A(t,e,s){return"right"===t||"left"===t?"right"===t?e+s:e-s:e}static D(t,e,s){return"right"===t||"left"===t?e:"bottom"===t?e+s:e-s}}function h(t,e,s){let n=function(t,e){for(const s of t)if(!e||e(s))return s;return null}(t.transform.baseVal,(t=>t.type===e));return n||(n=(t.ownerSVGElement||s).createSVGTransform(),t.transform.baseVal.appendItem(n)),n}function c(t){const e=h(t,SVGTransform.SVG_TRANSFORM_TRANSLATE).matrix;return{x:e.e,y:e.f}}class a{constructor({svgEl:t,connectorType:e,shape:s,key:n,innerPosition:i,dir:o}){this.I=t,this.K=new Set,this.type="connector",this.connectorType=e,this.shape=s,this.key=n,this.innerPosition=i,this.dir=o}stateGet(){return this.K}update(t){this.K=t.state,this.K.has("connected")?this.I.classList.add("connected"):this.I.classList.remove("connected"),this.K.has("hovered")?this.I.classList.add("hover"):this.I.classList.remove("hover")}}class l{constructor({svgEl:t,type:e=null,connectable:s=null,defaultInConnector:n=null}){this.K=new Set,this.svgEl=t,this.type=e||"shape",this.connectable=s,this.defaultInConnector=n,this.connectors=new Map}stateGet(){return this.K}postionGet(){return c(this.svgEl)}update(t){var e,s,n;t.position&&(e=this.svgEl,s=t.position,h(e,SVGTransform.SVG_TRANSFORM_TRANSLATE,n).setTranslate(s.x,s.y)),t.rotate&&function(t,e,s){h(t,SVGTransform.SVG_TRANSFORM_ROTATE,s).setRotate(e,0,0)}(this.svgEl,t.rotate),t.props&&l.V(this.svgEl,t.props),t.state&&(this.K=t.state,this.K.has("selected")?this.svgEl.classList.add("selected"):this.svgEl.classList.remove("selected"),this.K.has("hovered")?this.svgEl.classList.add("hover"):this.svgEl.classList.remove("hover"),this.K.has("disabled")?this.svgEl.style.pointerEvents="none":this.svgEl.style.pointerEvents="auto")}static V(t,e){Object.keys(e).forEach((s=>{const n="root"===s?t:t.querySelector(`[data-key='${s}'`);Object.keys(e[s]).forEach((t=>{if("textContent"===t)n.textContent=e[s][t].toString();else n.setAttribute(t,e[s][t].toString())}))}))}}function d(t,e){return new a({svgEl:t,connectorType:"in"===t.getAttribute("data-connect")?"in":"out",shape:e,key:t.getAttribute("data-key"),innerPosition:u(t),dir:t.getAttribute("data-connect-dir")})}function u(t){if(!t.getAttribute("data-connect-point"))return null;const e=t.getAttribute("data-connect-point").split(",");return{x:parseFloat(e[0]),y:parseFloat(e[1])}}class p extends EventTarget{constructor(t){super(),this.F=t,this.F.addEventListener("pointermove",this),this.F.addEventListener("pointerdown",this),this.F.addEventListener("pointerup",this),this.W=new WeakMap,this.B=t.querySelector('[data-key="canvas"]'),this.W.set(this.B,new l({svgEl:this.B,type:"canvas"}))}append(t,e){switch(t){case"shape":return function({svgCanvas:t,listener:e,svgElemToPresenterObj:s,createParams:n}){const i=t.ownerSVGElement.getElementsByTagName("defs")[0].querySelector(`[data-templ='${n.templateKey}']`).cloneNode(!0);t.append(i);const o=new l({svgEl:i});if(!n.postionIsIntoCanvas){const e=c(t);n.position.x-=e.x,n.position.y-=e.y}return o.update(n),o.connectable="true"===i.getAttribute("data-connectable"),u(i)&&(o.defaultInConnector=d(i,o)),i.addEventListener("pointerdown",e),i.querySelectorAll("[data-connect]").forEach((t=>{const n=d(t,o);t.addEventListener("pointerdown",e),s.set(t,n),o.connectors.set(n.key,n)})),s.set(i,o),o}({svgCanvas:this.B,svgElemToPresenterObj:this.W,listener:this,createParams:e});case"path":return function({svgCanvas:t,createParams:e}){const s=t.ownerSVGElement.getElementsByTagName("defs")[0].querySelector(`[data-templ='${e.templateKey}']`).cloneNode(!0);return t.append(s),new r({svgEl:s,start:e.start,end:e.end})}({svgCanvas:this.B,createParams:e})}}delete(t){this.W.delete(t.svgEl),t.svgEl.remove()}on(t,e){return this.addEventListener(t,e),this}handleEvent(t){switch(t.stopPropagation(),t.type){case"pointermove":this.L(t),this.$("pointermove",null,t.offsetX,t.offsetY);break;case"pointerdown":this.$(t.type,t.currentTarget,t.offsetX,t.offsetY);break;case"pointerup":this.$(t.type,document.elementFromPoint(t.clientX,t.clientY),t.offsetX,t.offsetY)}}L(t){const e=document.elementFromPoint(t.clientX,t.clientY);e!==this.R&&(this.R&&this.$("pointerleave",this.R,t.offsetX,t.offsetY),e&&this.$("pointerenter",e,t.offsetX,t.offsetY),this.R=e)}$(t,e,s,n){let i=null;e&&(i=this.W.get(e===this.F||e.ownerSVGElement!==this.F?this.B:e),i||(i=this.W.get(e.closest("[data-connect]"))),i||(i=this.W.get(e.closest("[data-templ]")))),this.dispatchEvent(new CustomEvent(t,{detail:{target:i,offsetX:s,offsetY:n}}))}}const f=document.getElementById("panel"),v=document.getElementById("text");v.addEventListener("input",(t=>y())),v.addEventListener("change",(t=>y())),document.getElementById("del").addEventListener("click",(t=>{t.preventDefault(),function(){if(!w)return;m.delete(w),g.shapeDel(w),b(null)}()})),document.getElementById("gear").addEventListener("click",(t=>{t.preventDefault(),f.classList.contains("open")?f.classList.remove("open"):f.classList.add("open")})),document.getElementById("menu").querySelectorAll("[data-shape]").forEach((t=>t.addEventListener("click",(t=>{var e;t.preventDefault(),e=t.currentTarget.getAttribute("data-shape"),m.set(g.shapeAdd({templateKey:e,position:{x:120,y:120},props:{text:{textContent:"Title"}}}),"Title")}))));const m=new WeakMap;let w;const g=function(t){const e=new p(t);return new o(e,new i(e))}(document.getElementById("diagram")).on("select",(t=>b(t.detail.target)));function y(){w&&(m.set(w,v.value),w.update({props:{text:{textContent:v.value}}}))}function b(t){t&&"shape"===t.type?(w=t,f.classList.add("selected"),m.has(t)?(v.value=m.get(t),v.disabled=!1):(v.value=null,v.disabled=!0)):(w=null,f.classList.remove("selected"))}}();
